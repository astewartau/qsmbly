<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QSMbly | Quantitative Susceptibility Mapping</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <!-- Tagify (load before our CSS so we can override) -->
  <link rel="stylesheet" href="https://unpkg.com/@yaireo/tagify/dist/tagify.css">
  <script src="https://unpkg.com/@yaireo/tagify"></script>

  <!-- Our styles last to override -->
  <link rel="stylesheet" href="css/modern-styles.css">

  <!-- NiiVue -->
  <script type="module">
    import { Niivue, NVImage } from "https://unpkg.com/@niivue/niivue@0.57.0/dist/index.js";
    window.Niivue = Niivue;
    window.NVImage = NVImage;
  </script>
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <header class="app-header">
      <div class="logo">
        <div class="logo-icon">
          <img src="QSMbly.png" alt="QSMbly" width="20" height="20">
        </div>
        <h1>QSMbly <span>Quantitative Susceptibility Mapping</span> <span class="version" id="appVersion"></span></h1>
      </div>
      <div class="header-links">
        <button class="header-link" id="openCitations" title="Citations">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
          </svg>
          <span>Citations</span>
        </button>
        <a href="https://github.com/astewartau/qsmbly" target="_blank" rel="noopener noreferrer" class="header-link" title="View on GitHub">
          <svg viewBox="0 0 16 16" width="20" height="20" fill="white">
            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
          </svg>
          <span>GitHub</span>
        </a>
      </div>
    </header>

    <!-- Sidebar -->
    <aside class="app-sidebar" id="sidebar">
      <!-- File Upload Section -->
      <section class="sidebar-section" id="inputSection">
        <h2 class="section-title" onclick="toggleSection(this.parentElement)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          Input Files
        </h2>
        <div class="section-content">
        <!-- Magnitude Files -->
        <div class="file-upload-group">
          <div class="file-upload-header">
            <label class="file-upload-label">
              Magnitude <span class="count" id="magCount"></span>
            </label>
            <button class="btn-icon btn-preview" id="vis_magnitude" title="Preview magnitude" disabled>
              <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
            </button>
          </div>
          <div class="upload-group">
            <div class="file-upload-zone file-drop" id="magnitudeDrop">
              <input type="file" id="magnitudeFiles" accept=".nii,.nii.gz" multiple>
              <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              <p class="upload-text file-drop-label"><span>Drop or click</span></p>
            </div>
            <div class="file-list" id="magnitudeList"></div>
          </div>
        </div>

        <!-- Phase Files -->
        <div class="file-upload-group">
          <div class="file-upload-header">
            <label class="file-upload-label">
              Phase <span class="count" id="phaseCount"></span>
            </label>
            <button class="btn-icon btn-preview" id="vis_phase" title="Preview phase" disabled>
              <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
            </button>
          </div>
          <div class="upload-group">
            <div class="file-upload-zone file-drop" id="phaseDrop">
              <input type="file" id="phaseFiles" accept=".nii,.nii.gz" multiple>
              <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              <p class="upload-text file-drop-label"><span>Drop or click</span></p>
            </div>
            <div class="file-list" id="phaseList"></div>
          </div>
        </div>
        </div>
      </section>

      <!-- Input Parameters Section -->
      <section class="sidebar-section collapsed" id="paramsSection">
        <h2 class="section-title" onclick="toggleSection(this.parentElement)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
          </svg>
          Input Parameters
        </h2>
        <div class="section-content">
        <!-- JSON Metadata Upload -->
        <div class="param-group">
          <label class="param-label">
            JSON Metadata <span class="count" id="jsonCount"></span>
          </label>
          <div class="upload-group compact">
            <div class="file-upload-zone file-drop compact" id="jsonDrop">
              <input type="file" id="jsonFiles" accept=".json" multiple>
              <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              <p class="upload-text file-drop-label"><span>Drop files or click</span></p>
            </div>
            <div class="file-list" id="jsonList"></div>
          </div>
        </div>

        <div class="param-group">
          <label class="param-label" for="magField">Field Strength</label>
          <div class="param-inline">
            <input type="number" id="magField" value="3.0" step="0.1" min="0.1">
            <span class="unit">Tesla</span>
          </div>
        </div>

        <div class="param-group">
          <label class="param-label">Echo Times <span class="unit-inline">(ms)</span></label>
          <input type="text" id="echoTimesTagify" placeholder="Type values...">
        </div>
        </div>
      </section>

      <!-- Mask Threshold Section -->
      <section class="sidebar-section section-disabled collapsed" id="maskSection">
        <h2 class="section-title" onclick="toggleSection(this.parentElement)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>
          </svg>
          Masking
        </h2>
        <div class="section-content">
        <!-- Mask Input Preparation -->
        <div class="param-group">
          <label class="param-label" for="maskInputSource">Mask Input</label>
          <select id="maskInputSource">
            <option value="first_echo">First-echo magnitude</option>
            <option value="combined" selected>Combined magnitude (RSS)</option>
          </select>
        </div>

        <div class="param-group">
          <label class="checkbox-label">
            <input type="checkbox" id="applyBiasCorrection" checked>
            <span>Apply bias correction</span>
          </label>
        </div>

        <button class="btn btn-secondary btn-sm" id="prepareMaskInput" style="width: 100%; margin-bottom: var(--space-sm);" disabled>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/>
          </svg>
          Prepare
        </button>

        <div class="mask-preview-buttons">
          <button class="btn btn-secondary btn-sm" id="previewMask" title="Generate mask from threshold" disabled>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
            Threshold
          </button>
          <button class="btn btn-secondary btn-sm" id="runBET" title="BET brain extraction (slower but more accurate)" disabled>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 8c-2.2 0-4 1.8-4 4s1.8 4 4 4 4-1.8 4-4"/>
            </svg>
            BET
          </button>
        </div>

        <!-- Threshold Slider (enabled only after Threshold button is pressed) -->
        <div class="param-group" id="thresholdSliderGroup" style="margin-top: var(--space-sm);">
          <div class="threshold-header">
            <label class="param-label" for="maskThreshold" id="thresholdLabel">Threshold</label>
            <button class="btn-icon" id="autoThreshold" title="Reset to Otsu threshold" disabled>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 4v6h-6"/>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
              </svg>
            </button>
          </div>
          <input type="range" id="maskThreshold" min="1" max="100" value="15" class="threshold-slider" disabled>
        </div>

        <!-- Morphological Operations (collapsible subsection) -->
        <div class="mask-operations subsection collapsed" id="maskOperations" style="display: none;">
          <div class="subsection-title" onclick="this.parentElement.classList.toggle('collapsed')">Refine Mask</div>
          <div class="subsection-content">
            <div class="mask-op-buttons">
              <button class="btn btn-secondary btn-sm" id="fillHoles" title="Fill holes inside the mask">
                Fill Holes
              </button>
              <button class="btn btn-secondary btn-sm" id="erodeMask" title="Shrink mask boundaries">
                Erode
              </button>
              <button class="btn btn-secondary btn-sm" id="dilateMask" title="Expand mask boundaries">
                Dilate
              </button>
              <button class="btn btn-secondary btn-sm" id="resetMask" title="Reset to threshold-based mask">
                Reset
              </button>
            </div>

            <!-- Drawing/Painting Tools -->
            <label class="param-label" style="margin-top: var(--space-sm); margin-bottom: var(--space-xs);">Paint Mask</label>
            <div class="drawing-controls">
              <div class="brush-mode-buttons">
                <button class="btn btn-secondary btn-sm" id="enableDrawing" title="Enable brush painting">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                    <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                    <path d="M2 2l7.586 7.586"/>
                  </svg>
                  Draw
                </button>
                <button class="btn btn-secondary btn-sm" id="brushAdd" title="Add to mask" disabled>
                  + Add
                </button>
                <button class="btn btn-secondary btn-sm" id="brushRemove" title="Remove from mask" disabled>
                  - Remove
                </button>
              </div>
              <div class="brush-size-control" id="brushSizeControl" style="display: none;">
                <label class="param-label" style="font-size: 0.7rem;">Brush Size: <span id="brushSizeValue">2</span></label>
                <input type="range" id="brushSize" min="1" max="10" value="2" class="threshold-slider">
              </div>
              <div class="drawing-actions" id="drawingActions" style="display: none;">
                <button class="btn btn-secondary btn-sm" id="undoDraw" title="Undo last stroke">
                  Undo
                </button>
                <button class="btn btn-primary btn-sm" id="applyDrawing" title="Apply drawing to mask">
                  Apply
                </button>
              </div>
            </div>
          </div>
        </div>
        </div>
      </section>

      <!-- Pipeline Section -->
      <section class="sidebar-section collapsed" id="pipelineSection">
        <h2 class="section-title" onclick="toggleSection(this.parentElement)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
          </svg>
          QSM Pipeline
        </h2>
        <div class="section-content">
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-secondary" id="openPipelineSettings" style="flex: 1;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
              </svg>
            </button>
            <button class="btn btn-primary" id="runPipelineSidebar" style="flex: 3;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="5 3 19 12 5 21 5 3"/>
              </svg>
              <span>Start QSM</span>
            </button>
          </div>
        </div>
      </section>

      <!-- Results Section - dynamically populated -->
      <section class="sidebar-section hidden collapsed" id="stage-buttons">
        <h2 class="section-title" onclick="toggleSection(this.parentElement)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
          Results
        </h2>
        <div class="section-content">
        <!-- Stage buttons are dynamically added here -->
        <div class="stage-buttons-grid" id="dynamicStageButtons"></div>
        <button class="btn btn-secondary btn-sm" id="clearAllResults" style="width: 100%; margin-top: var(--space-sm);">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"/>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
          </svg>
          Clear All
        </button>
        </div>
      </section>

      <!-- Status Bar (fixed at bottom) -->
      <div class="sidebar-status" id="statusBar">
        <div class="status-header">
          <span class="status-label">Status</span>
          <div class="status-right">
            <span class="status-value" id="progressText">Ready</span>
            <button class="btn-status-cancel" id="cancelPipeline" title="Cancel pipeline" disabled>
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="app-main">
      <!-- Viewer Toolbar -->
      <div class="viewer-toolbar">
        <div class="view-tabs">
          <button class="view-tab active" data-view="multiplanar">3-Plane</button>
          <button class="view-tab" data-view="axial">Axial</button>
          <button class="view-tab" data-view="coronal">Coronal</button>
          <button class="view-tab" data-view="sagittal">Sagittal</button>
          <button class="view-tab" data-view="render">3D</button>
        </div>

        <!-- Echo Navigation (hidden when not multi-echo) -->
        <div class="echo-nav" id="echoNav" style="display: none;">
          <button class="btn btn-sm btn-icon" id="echoPrev" title="Previous echo">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
          </button>
          <span class="echo-label" id="echoLabel">Echo 1/1</span>
          <button class="btn btn-sm btn-icon" id="echoNext" title="Next echo">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
              <polyline points="9 18 15 12 9 6"/>
            </svg>
          </button>
        </div>

        <div class="viewer-actions">
          <div class="window-controls">
            <input type="number" id="windowMin" class="window-input" placeholder="min" step="any" title="Window minimum">
            <div class="range-slider-container">
              <input type="range" id="rangeMin" class="range-slider range-min" min="0" max="100" value="0">
              <input type="range" id="rangeMax" class="range-slider range-max" min="0" max="100" value="100">
              <div class="range-track"></div>
              <div class="range-selected" id="rangeSelected"></div>
            </div>
            <input type="number" id="windowMax" class="window-input" placeholder="max" step="any" title="Window maximum">
            <button class="btn btn-sm" id="resetWindow" title="Reset to full range">Auto</button>
          </div>
          <label class="interp-checkbox">
            <input type="checkbox" id="interpolation">
            <span>Interp</span>
          </label>
          <span class="data-units" id="dataUnits"></span>
          <label class="opacity-control" id="overlayOpacityControl" style="display: none;">
            <span>Overlay</span>
            <input type="range" id="overlayOpacity" min="0" max="100" value="50">
            <span id="overlayOpacityValue">50%</span>
          </label>
          <select class="colormap-select" id="colormapSelect">
            <option value="gray">Gray</option>
            <option value="hot">Hot</option>
            <option value="cool">Cool</option>
            <option value="viridis">Viridis</option>
            <option value="plasma">Plasma</option>
          </select>
          <label class="interp-checkbox">
            <input type="checkbox" id="colorbarToggle">
            <span>Colorbar</span>
          </label>
          <label class="interp-checkbox">
            <input type="checkbox" id="crosshairToggle" checked>
            <span>Crosshair</span>
          </label>
          <button class="btn btn-sm btn-icon" id="downloadCurrentVolume" title="Download current image as NIfTI" disabled>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
          </button>
          <button class="btn btn-sm btn-icon" id="screenshotViewer" title="Save screenshot as PNG">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- NiiVue Canvas -->
      <div class="viewer-canvas-wrapper">
        <canvas id="gl1"></canvas>
      </div>

      <!-- Viewer Info Bar -->
      <div class="viewer-info">
        <span id="intensity">Upload an image to begin</span>
      </div>

      <!-- Console -->
      <div class="console-container" id="console">
        <div class="console-header">
          <span class="console-title">Console</span>
          <button class="console-clear" id="clearConsole">Clear</button>
        </div>
        <div class="console-output" id="consoleOutput">
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="app-footer">
      <span>QSMbly | Browser-based Quantitative Susceptibility Mapping</span>
      <span>Powered by Rust, WebAssembly &amp; NiiVue</span>
    </footer>
  </div>

  <!-- Modals (outside app-container for proper z-index stacking) -->
  <!-- Pipeline Settings Modal -->
  <div class="modal-overlay" id="pipelineSettingsModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Pipeline Settings</h3>
        <button class="modal-close" id="closePipelineSettings">&times;</button>
      </div>
      <div class="modal-body">
        <!-- QSM Pipeline Method Section -->
        <div class="settings-section">
          <h4>QSM Pipeline</h4>
          <div class="param-group">
            <label class="param-label" for="combinedMethod">Method</label>
            <select id="combinedMethod">
              <option value="none" selected>Standard Pipeline</option>
              <option value="tgv">TGV</option>
              <option value="qsmart">QSMART</option>
            </select>
          </div>

          <!-- TGV Settings -->
          <div id="tgvSettings" class="method-settings" style="display: none;">
            <div class="method-links">
              <a href="https://doi.org/10.1016/j.neuroimage.2015.02.041" target="_blank" rel="noopener" title="DOI: 10.1016/j.neuroimage.2015.02.041"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Paper</a>
              <a href="https://doi.org/10.1002/nbm.3570" target="_blank" rel="noopener" title="DOI: 10.1002/nbm.3570"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Paper</a>
              <a href="https://github.com/korbinian90/QuantitativeSusceptibilityMappingTGV.jl" target="_blank" rel="noopener" title="Code: QuantitativeSusceptibilityMappingTGV.jl"><svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>Code</a>
            </div>
            <div class="param-group">
              <label class="param-label" for="tgvRegularization">Regularization Level</label>
              <select id="tgvRegularization">
                <option value="1">1 - Low (sharper, more noise)</option>
                <option value="2" selected>2 - Default</option>
                <option value="3">3 - High (smoother)</option>
                <option value="4">4 - Very High (very smooth)</option>
              </select>
            </div>
            <div class="param-group">
              <label class="param-label" for="tgvIterations">Iterations</label>
              <input type="number" id="tgvIterations" value="1000" min="100" max="5000" step="100">
            </div>
            <div class="param-group">
              <label class="param-label" for="tgvErosions">Mask Erosions</label>
              <input type="number" id="tgvErosions" value="3" min="0" max="10" step="1">
            </div>
          </div>

          <!-- QSMART Settings -->
          <div id="qsmartSettings" class="method-settings" style="display: none;">
            <div class="method-links">
              <a href="https://doi.org/10.1016/j.neuroimage.2021.117701" target="_blank" rel="noopener" title="DOI: 10.1016/j.neuroimage.2021.117701"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Paper</a>
              <a href="https://github.com/wtsyeda/QSMART" target="_blank" rel="noopener" title="Code: QSMART"><svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>Code</a>
            </div>

            <h5 style="margin: var(--space-sm) 0 var(--space-xs); font-size: 0.8rem; color: var(--color-text-muted);">Stage 1: Whole ROI</h5>
            <div class="param-group">
              <label class="param-label" for="qsmartSdfSigma1Stage1">SDF Sigma 1 (voxels)</label>
              <input type="number" id="qsmartSdfSigma1Stage1" value="10" min="1" max="30" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="qsmartSdfSigma2Stage1">SDF Sigma 2 (voxels)</label>
              <input type="number" id="qsmartSdfSigma2Stage1" value="0" min="0" max="30" step="1">
            </div>

            <h5 style="margin: var(--space-sm) 0 var(--space-xs); font-size: 0.8rem; color: var(--color-text-muted);">Stage 2: Tissue Only</h5>
            <div class="param-group">
              <label class="param-label" for="qsmartSdfSigma1Stage2">SDF Sigma 1 (voxels)</label>
              <input type="number" id="qsmartSdfSigma1Stage2" value="8" min="1" max="30" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="qsmartSdfSigma2Stage2">SDF Sigma 2 (voxels)</label>
              <input type="number" id="qsmartSdfSigma2Stage2" value="2" min="0" max="30" step="1">
            </div>

            <h5 style="margin: var(--space-sm) 0 var(--space-xs); font-size: 0.8rem; color: var(--color-text-muted);">SDF Parameters</h5>
            <div class="param-group">
              <label class="param-label" for="qsmartSdfSpatialRadius">Spatial Radius (voxels)</label>
              <input type="number" id="qsmartSdfSpatialRadius" value="8" min="1" max="20" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="qsmartSdfLowerLim">Lower Limit (proximity)</label>
              <input type="number" id="qsmartSdfLowerLim" value="0.6" min="0.1" max="1.0" step="0.1">
            </div>
            <div class="param-group">
              <label class="param-label" for="qsmartSdfCurvConstant">Curvature Constant</label>
              <input type="number" id="qsmartSdfCurvConstant" value="500" min="100" max="2000" step="50">
            </div>

            <h5 style="margin: var(--space-sm) 0 var(--space-xs); font-size: 0.8rem; color: var(--color-text-muted);">Vasculature Detection (Frangi)</h5>
            <p style="font-size: 0.7rem; color: var(--color-text-muted); margin: 0 0 var(--space-xs);">Parameters in mm - auto-scaled to voxels</p>
            <div class="param-group">
              <label class="param-label" for="qsmartVascSphereRadius">Bottom-hat Radius (mm)</label>
              <input type="number" id="qsmartVascSphereRadius" value="8" min="2" max="20" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="qsmartFrangiScaleMin">Min Vessel Radius (mm)</label>
              <input type="number" id="qsmartFrangiScaleMin" value="1.0" min="0.5" max="5.0" step="0.5">
            </div>
            <div class="param-group">
              <label class="param-label" for="qsmartFrangiScaleMax">Max Vessel Radius (mm)</label>
              <input type="number" id="qsmartFrangiScaleMax" value="10.0" min="1.0" max="20.0" step="1.0">
            </div>
            <div class="param-group">
              <label class="param-label" for="qsmartFrangiScaleRatio">Scale Step (mm)</label>
              <input type="number" id="qsmartFrangiScaleRatio" value="2.0" min="0.5" max="5.0" step="0.5">
            </div>
            <div class="param-group">
              <label class="param-label" for="qsmartFrangiC">Frangi C (noise threshold)</label>
              <input type="number" id="qsmartFrangiC" value="500" min="100" max="2000" step="50">
            </div>

            <h5 style="margin: var(--space-sm) 0 var(--space-xs); font-size: 0.8rem; color: var(--color-text-muted);">iLSQR Inversion</h5>
            <div class="param-group">
              <label class="param-label" for="qsmartIlsqrTol">Tolerance</label>
              <input type="number" id="qsmartIlsqrTol" value="0.01" min="0.001" max="0.1" step="0.001">
            </div>
            <div class="param-group">
              <label class="param-label" for="qsmartIlsqrMaxIter">Max Iterations</label>
              <input type="number" id="qsmartIlsqrMaxIter" value="50" min="10" max="200" step="10">
            </div>
          </div>
        </div>

        <!-- ============================================================ -->
        <!-- Phase Processing Section (Multi-Echo) -->
        <!-- ============================================================ -->
        <div class="settings-section" id="multiEchoSection">
          <h4>Phase Processing</h4>

          <!-- Step 1: Phase Offset Removal -->
          <div class="param-group">
            <label class="param-label" for="phaseOffsetMethod">Phase Offset Removal</label>
            <select id="phaseOffsetMethod">
              <option value="mcpc3ds" selected>MCPC-3D-S</option>
              <option value="none">None (skip)</option>
            </select>
          </div>

          <!-- MCPC-3D-S Settings -->
          <div id="mcpc3dsSettings" class="method-settings" style="margin-left: var(--space-md); padding-left: var(--space-md); border-left: 2px solid var(--color-border);">
            <div class="method-links">
              <a href="https://doi.org/10.1002/mrm.27277" target="_blank" rel="noopener" title="DOI: 10.1002/mrm.27277"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Paper</a>
              <a href="https://github.com/korbinian90/MriResearchTools.jl" target="_blank" rel="noopener" title="Code: MriResearchTools.jl"><svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>Code</a>
            </div>
            <div class="param-group">
              <label class="param-label" for="mcpc3dsSigmaX">Smoothing Sigma X (voxels)</label>
              <input type="number" id="mcpc3dsSigmaX" value="10" min="1" max="30" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="mcpc3dsSigmaY">Smoothing Sigma Y (voxels)</label>
              <input type="number" id="mcpc3dsSigmaY" value="10" min="1" max="30" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="mcpc3dsSigmaZ">Smoothing Sigma Z (voxels)</label>
              <input type="number" id="mcpc3dsSigmaZ" value="5" min="1" max="30" step="1">
            </div>
          </div>

          <!-- Step 2: Phase Unwrapping -->
          <div class="param-group" style="margin-top: var(--space-md);">
            <label class="param-label" for="unwrapMethod">Phase Unwrapping</label>
            <select id="unwrapMethod">
              <option value="romeo" selected>ROMEO</option>
              <option value="laplacian">Laplacian</option>
            </select>
            <div id="unwrapLockedHint" class="param-hint" style="display: none; color: var(--color-text-muted); font-style: italic;">
              Locked to ROMEO (required by MCPC-3D-S)
            </div>
          </div>

          <!-- ROMEO Settings -->
          <div id="romeoSettings" class="method-settings" style="margin-left: var(--space-md); padding-left: var(--space-md); border-left: 2px solid var(--color-border);">
            <div class="method-links">
              <a href="https://doi.org/10.1002/mrm.28563" target="_blank" rel="noopener" title="DOI: 10.1002/mrm.28563"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Paper</a>
              <a href="https://github.com/korbinian90/MriResearchTools.jl" target="_blank" rel="noopener" title="Code: MriResearchTools.jl"><svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>Code</a>
            </div>
            <div class="param-group" style="display: flex; flex-direction: column; gap: var(--space-xs); font-size: 0.8rem;">
              <label style="display: flex; align-items: center; gap: var(--space-xs);">
                <input type="checkbox" id="romeoPhaseCoherence" checked disabled>
                Phase Coherence
              </label>
              <label style="display: flex; align-items: center; gap: var(--space-xs);">
                <input type="checkbox" id="romeoPhaseGradientCoherence" checked>
                Phase Gradient Coherence
              </label>
              <label style="display: flex; align-items: center; gap: var(--space-xs);">
                <input type="checkbox" id="romeoMagCoherence" checked>
                Magnitude Coherence
              </label>
              <label style="display: flex; align-items: center; gap: var(--space-xs);">
                <input type="checkbox" id="romeoMagWeight" checked>
                Magnitude Weight
              </label>
            </div>
          </div>

          <!-- Laplacian Settings -->
          <div id="laplacianSettings" class="method-settings" style="display: none; margin-left: var(--space-md); padding-left: var(--space-md); border-left: 2px solid var(--color-border);">
            <div class="method-links">
              <a href="https://doi.org/10.1364/OL.28.001194" target="_blank" rel="noopener" title="DOI: 10.1364/OL.28.001194"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Paper</a>
              <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener" title="Code: QSM.jl"><svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>Code</a>
            </div>
          </div>

          <!-- Step 3: Multi-Echo Fitting -->
          <div class="param-group" style="margin-top: var(--space-md);">
            <label class="param-label" for="fieldCalculationMethod">Multi-Echo Fitting</label>
            <select id="fieldCalculationMethod">
              <option value="weighted_avg" selected>Weighted Averaging</option>
              <option value="linear_fit">Linear Fit</option>
            </select>
          </div>

          <!-- Weighted Averaging Settings -->
          <div id="weightedAvgSettings" class="method-settings" style="margin-left: var(--space-md); padding-left: var(--space-md); border-left: 2px solid var(--color-border);">
            <div class="param-group">
              <label class="param-label" for="b0WeightType">Weight Type</label>
              <select id="b0WeightType">
                <option value="phase_snr" selected>Phase SNR (mag × TE)</option>
                <option value="phase_var">Phase Variance (mag² × TE²)</option>
                <option value="average">Uniform</option>
                <option value="tes">TE only</option>
                <option value="mag">Magnitude only</option>
              </select>
            </div>
          </div>

          <!-- Linear Fit Settings -->
          <div id="linearFitSettings" class="method-settings" style="display: none; margin-left: var(--space-md); padding-left: var(--space-md); border-left: 2px solid var(--color-border);">
          </div>
        </div>

        <!-- Phase Unwrapping for Single-echo -->
        <div class="settings-section" id="singleEchoUnwrapSection" style="display: none;">
          <h4>Phase Unwrapping</h4>
          <div class="param-group">
            <label class="param-label" for="singleEchoUnwrapMethod">Method</label>
            <select id="singleEchoUnwrapMethod">
              <option value="romeo" selected>ROMEO</option>
              <option value="laplacian">Laplacian</option>
            </select>
          </div>
          <div id="singleEchoRomeoSettings" class="method-settings">
            <div class="method-links">
              <a href="https://doi.org/10.1002/mrm.28563" target="_blank" rel="noopener" title="DOI: 10.1002/mrm.28563"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Paper</a>
              <a href="https://github.com/korbinian90/MriResearchTools.jl" target="_blank" rel="noopener" title="Code: MriResearchTools.jl"><svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>Code</a>
            </div>
            <div class="param-group" style="display: flex; flex-direction: column; gap: var(--space-xs); font-size: 0.8rem;">
              <label style="display: flex; align-items: center; gap: var(--space-xs);">
                <input type="checkbox" id="singleEchoRomeoPhaseCoherence" checked disabled>
                Phase Coherence
              </label>
              <label style="display: flex; align-items: center; gap: var(--space-xs);">
                <input type="checkbox" id="singleEchoRomeoMagCoherence" checked>
                Magnitude Coherence
              </label>
              <label style="display: flex; align-items: center; gap: var(--space-xs);">
                <input type="checkbox" id="singleEchoRomeoMagWeight" checked>
                Magnitude Weight
              </label>
            </div>
          </div>
          <div id="singleEchoLaplacianSettings" class="method-settings" style="display: none;">
            <div class="method-links">
              <a href="https://doi.org/10.1364/OL.28.001194" target="_blank" rel="noopener" title="DOI: 10.1364/OL.28.001194"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Paper</a>
              <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener" title="Code: QSM.jl"><svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>Code</a>
            </div>
          </div>
        </div>

        <!-- Background Removal -->
        <div class="settings-section" id="bgRemovalSection">
          <h4>Background Removal</h4>
          <div id="bgRemovalDisabledHint" class="param-hint" style="display: none; margin-bottom: var(--space-sm); color: var(--color-text-muted); font-style: italic;">
            Disabled — MEDI with SMV preprocessing handles background removal internally using differential form (avoids deconvolution artifacts).
          </div>
          <div class="param-group">
            <label class="param-label" for="bgRemovalMethod">Method</label>
            <select id="bgRemovalMethod">
              <option value="vsharp" selected>V-SHARP</option>
              <option value="sharp">SHARP</option>
              <option value="smv">SMV</option>
              <option value="ismv">iSMV</option>
              <option value="pdf">PDF</option>
              <option value="lbv">LBV</option>
            </select>
          </div>

          <!-- V-SHARP Settings -->
          <div id="vsharpSettings" class="method-settings">
            <div class="method-links">
              <a href="https://doi.org/10.1002/mrm.23000" target="_blank" rel="noopener" title="DOI: 10.1002/mrm.23000"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Paper</a>
              <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener" title="Code: QSM.jl"><svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>Code</a>
            </div>
            <div class="param-group">
              <label class="param-label" for="vsharpMaxRadius">Max Radius (mm)</label>
              <input type="number" id="vsharpMaxRadius" value="18" min="4" max="30" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="vsharpMinRadius">Min Radius (mm)</label>
              <input type="number" id="vsharpMinRadius" value="2" min="1" max="10" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="vsharpThreshold">Threshold</label>
              <input type="number" id="vsharpThreshold" value="0.05" min="0.01" max="0.2" step="0.01">
            </div>
          </div>

          <!-- SHARP Settings -->
          <div id="sharpSettings" class="method-settings" style="display: none;">
            <div class="method-links">
              <a href="https://doi.org/10.1016/j.neuroimage.2010.10.070" target="_blank" rel="noopener" title="DOI: 10.1016/j.neuroimage.2010.10.070"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Paper</a>
              <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener" title="Code: QSM.jl"><svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>Code</a>
            </div>
            <div class="param-group">
              <label class="param-label" for="sharpRadius">Radius (mm)</label>
              <input type="number" id="sharpRadius" value="6" min="1" max="20" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="sharpThreshold">Threshold</label>
              <input type="number" id="sharpThreshold" value="0.05" min="0.01" max="0.2" step="0.01">
            </div>
          </div>

          <!-- SMV Settings -->
          <div id="smvSettings" class="method-settings">
            <div class="method-links">
              <a href="https://doi.org/10.1016/j.neuroimage.2010.10.070" target="_blank" rel="noopener" title="DOI: 10.1016/j.neuroimage.2010.10.070"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Paper</a>
              <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener" title="Code: QSM.jl"><svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>Code</a>
            </div>
            <div class="param-group">
              <label class="param-label" for="smvRadius">Radius (mm)</label>
              <input type="number" id="smvRadius" value="5" min="1" max="20" step="1">
            </div>
          </div>

          <!-- iSMV Settings -->
          <div id="ismvSettings" class="method-settings" style="display: none;">
            <div class="method-links">
              <a href="https://doi.org/10.1002/mrm.24998" target="_blank" rel="noopener" title="DOI: 10.1002/mrm.24998"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Paper</a>
              <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener" title="Code: QSM.jl"><svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>Code</a>
            </div>
            <div class="param-group">
              <label class="param-label" for="ismvRadius">Radius (mm)</label>
              <input type="number" id="ismvRadius" value="5" min="1" max="20" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="ismvTol">Tolerance</label>
              <input type="number" id="ismvTol" value="0.001" min="0.0001" max="0.01" step="0.0001">
            </div>
            <div class="param-group">
              <label class="param-label" for="ismvMaxit">Max Iterations</label>
              <input type="number" id="ismvMaxit" value="500" min="50" max="1000" step="50">
            </div>
          </div>

          <!-- PDF Settings -->
          <div id="pdfSettings" class="method-settings" style="display: none;">
            <div class="method-links">
              <a href="https://doi.org/10.1002/nbm.1670" target="_blank" rel="noopener" title="DOI: 10.1002/nbm.1670"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Paper</a>
              <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener" title="Code: QSM.jl"><svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>Code</a>
            </div>
            <div class="param-group">
              <label class="param-label" for="pdfTol">Tolerance</label>
              <input type="number" id="pdfTol" value="0.00001" min="0.000001" max="0.001" step="0.000001">
            </div>
            <div class="param-group">
              <label class="param-label" for="pdfMaxit">Max Iterations</label>
              <input type="number" id="pdfMaxit" value="100" min="10" max="500" step="10">
            </div>
          </div>

          <!-- LBV Settings -->
          <div id="lbvSettings" class="method-settings" style="display: none;">
            <div class="method-links">
              <a href="https://doi.org/10.1002/nbm.3064" target="_blank" rel="noopener" title="DOI: 10.1002/nbm.3064"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Paper</a>
              <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener" title="Code: QSM.jl"><svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>Code</a>
            </div>
            <div class="param-group">
              <label class="param-label" for="lbvTol">Tolerance</label>
              <input type="number" id="lbvTol" value="0.001" min="0.0001" max="0.01" step="0.0001">
            </div>
            <div class="param-group">
              <label class="param-label" for="lbvMaxit">Max Iterations</label>
              <input type="number" id="lbvMaxit" value="500" min="50" max="2000" step="50">
            </div>
          </div>
        </div>

        <!-- Dipole Inversion -->
        <div class="settings-section" id="dipoleInversionSection">
          <h4>Dipole Inversion</h4>
          <div class="param-group">
            <label class="param-label" for="dipoleMethod">Method</label>
            <select id="dipoleMethod">
              <option value="tkd">TKD</option>
              <option value="tsvd">TSVD</option>
              <option value="tikhonov">Tikhonov</option>
              <option value="tv" selected>TV-ADMM</option>
              <option value="rts">RTS</option>
              <option value="nltv">NLTV</option>
              <option value="medi">MEDI</option>
              <option value="ilsqr">iLSQR</option>
            </select>
          </div>

          <!-- TKD Settings -->
          <div id="tkdSettings" class="method-settings" style="display: none;">
            <div class="method-links">
              <a href="https://doi.org/10.1002/mrm.22135" target="_blank" rel="noopener" title="DOI: 10.1002/mrm.22135"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Paper</a>
              <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener" title="Code: QSM.jl"><svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>Code</a>
            </div>
            <div class="param-group">
              <label class="param-label" for="tkdThreshold">Threshold</label>
              <input type="number" id="tkdThreshold" value="0.15" min="0.05" max="0.3" step="0.01">
            </div>
          </div>

          <!-- TSVD Settings -->
          <div id="tsvdSettings" class="method-settings" style="display: none;">
            <div class="method-links">
              <a href="https://doi.org/10.1002/mrm.22135" target="_blank" rel="noopener" title="DOI: 10.1002/mrm.22135"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Paper</a>
              <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener" title="Code: QSM.jl"><svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>Code</a>
            </div>
            <div class="param-group">
              <label class="param-label" for="tsvdThreshold">Threshold</label>
              <input type="number" id="tsvdThreshold" value="0.15" min="0.05" max="0.3" step="0.01">
            </div>
          </div>

          <!-- Tikhonov Settings -->
          <div id="tikhonovSettings" class="method-settings" style="display: none;">
            <div class="method-links">
              <a href="https://doi.org/10.1002/jmri.24365" target="_blank" rel="noopener" title="DOI: 10.1002/jmri.24365"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Paper</a>
              <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener" title="Code: QSM.jl"><svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>Code</a>
            </div>
            <div class="param-group">
              <label class="param-label" for="tikhLambda">Lambda (regularization)</label>
              <input type="number" id="tikhLambda" value="0.01" min="0.001" max="1.0" step="0.001">
            </div>
            <div class="param-group">
              <label class="param-label" for="tikhReg">Regularization Type</label>
              <select id="tikhReg">
                <option value="identity" selected>Identity (minimal smoothing)</option>
                <option value="gradient">Gradient (moderate smoothing)</option>
                <option value="laplacian">Laplacian (strong smoothing)</option>
              </select>
            </div>
          </div>

          <!-- TV-ADMM Settings -->
          <div id="tvSettings" class="method-settings">
            <div class="method-links">
              <a href="https://doi.org/10.1002/mrm.25029" target="_blank" rel="noopener" title="DOI: 10.1002/mrm.25029"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Paper</a>
              <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener" title="Code: QSM.jl"><svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>Code</a>
            </div>
            <div class="param-group">
              <label class="param-label" for="tvLambda">Lambda (TV regularization)</label>
              <input type="number" id="tvLambda" value="0.001" min="0.0001" max="0.1" step="0.0001">
            </div>
            <div class="param-group">
              <label class="param-label" for="tvMaxIter">Max Iterations</label>
              <input type="number" id="tvMaxIter" value="250" min="10" max="500" step="10">
            </div>
            <div class="param-group">
              <label class="param-label" for="tvTol">Tolerance</label>
              <input type="number" id="tvTol" value="0.001" min="0.0001" max="0.01" step="0.0001">
            </div>
          </div>

          <!-- RTS Settings -->
          <div id="rtsSettings" class="method-settings" style="display: none;">
            <div class="method-links">
              <a href="https://doi.org/10.1016/j.neuroimage.2017.11.018" target="_blank" rel="noopener" title="DOI: 10.1016/j.neuroimage.2017.11.018"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Paper</a>
              <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener" title="Code: QSM.jl"><svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>Code</a>
            </div>
            <div class="param-group">
              <label class="param-label" for="rtsDelta">Delta (threshold)</label>
              <input type="number" id="rtsDelta" value="0.15" min="0.05" max="0.3" step="0.01">
            </div>
            <div class="param-group">
              <label class="param-label" for="rtsMu">Mu (data fidelity)</label>
              <input type="number" id="rtsMu" value="100000" min="1000" max="1000000" step="1000">
            </div>
            <div class="param-group">
              <label class="param-label" for="rtsRho">Rho (ADMM penalty)</label>
              <input type="number" id="rtsRho" value="10" min="1" max="100" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="rtsMaxIter">Max Iterations</label>
              <input type="number" id="rtsMaxIter" value="20" min="5" max="100" step="5">
            </div>
          </div>

          <!-- NLTV Settings -->
          <div id="nltvSettings" class="method-settings" style="display: none;">
            <div class="method-links">
              <a href="https://doi.org/10.1016/j.neuroimage.2017.11.018" target="_blank" rel="noopener" title="DOI: 10.1016/j.neuroimage.2017.11.018"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Paper</a>
              <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener" title="Code: QSM.jl"><svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>Code</a>
            </div>
            <div class="param-group">
              <label class="param-label" for="nltvLambda">Lambda (TV regularization)</label>
              <input type="number" id="nltvLambda" value="0.001" min="0.0001" max="0.1" step="0.0001">
            </div>
            <div class="param-group">
              <label class="param-label" for="nltvMu">Mu (data fidelity)</label>
              <input type="number" id="nltvMu" value="1" min="0.1" max="10" step="0.1">
            </div>
            <div class="param-group">
              <label class="param-label" for="nltvMaxIter">Max Iterations</label>
              <input type="number" id="nltvMaxIter" value="250" min="50" max="1000" step="50">
            </div>
            <div class="param-group">
              <label class="param-label" for="nltvTol">Tolerance</label>
              <input type="number" id="nltvTol" value="0.001" min="0.0001" max="0.01" step="0.0001">
            </div>
            <div class="param-group">
              <label class="param-label" for="nltvNewtonMaxIter">Newton Max Iterations</label>
              <input type="number" id="nltvNewtonMaxIter" value="10" min="1" max="50" step="1">
            </div>
          </div>

          <!-- MEDI Settings -->
          <div id="mediSettings" class="method-settings" style="display: none;">
            <div class="method-links">
              <a href="https://doi.org/10.1002/mrm.22816" target="_blank" rel="noopener" title="DOI: 10.1002/mrm.22816"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Paper</a>
              <a href="https://github.com/huawu02/MEDI_toolbox" target="_blank" rel="noopener" title="Code: MEDI_toolbox"><svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>Code</a>
            </div>
            <div class="param-group">
              <label class="param-label" for="mediLambda">Lambda (regularization)</label>
              <input type="number" id="mediLambda" value="7.5e-5" min="1e-6" max="0.01" step="1e-5">
            </div>
            <div class="param-group">
              <label class="param-label" for="mediPercentage">Edge Percentage</label>
              <input type="number" id="mediPercentage" value="0.3" min="0.05" max="0.95" step="0.05">
            </div>
            <div class="param-group">
              <label class="param-label" for="mediMaxIter">Max Iterations</label>
              <input type="number" id="mediMaxIter" value="30" min="1" max="100" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="mediCgMaxIter">CG Max Iterations</label>
              <input type="number" id="mediCgMaxIter" value="10" min="1" max="100" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="mediSmv">
                <input type="checkbox" id="mediSmv"> Enable SMV preprocessing
              </label>
            </div>
            <div class="param-group" id="mediSmvRadiusGroup" style="display: none;">
              <label class="param-label" for="mediSmvRadius">SMV Radius (mm)</label>
              <input type="number" id="mediSmvRadius" value="5" min="1" max="20" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="mediMerit">
                <input type="checkbox" id="mediMerit"> Enable Merit adjustment
              </label>
            </div>
          </div>

          <!-- iLSQR Settings -->
          <div id="ilsqrSettings" class="method-settings" style="display: none;">
            <div class="method-links">
              <a href="https://doi.org/10.1016/j.neuroimage.2014.12.043" target="_blank" rel="noopener" title="DOI: 10.1016/j.neuroimage.2014.12.043"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Paper</a>
              <a href="https://github.com/kamesy/QSM.m" target="_blank" rel="noopener" title="Code: QSM.m"><svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>Code</a>
            </div>
            <div class="param-group">
              <label class="param-label" for="ilsqrTol">Tolerance</label>
              <input type="number" id="ilsqrTol" value="0.01" min="0.001" max="0.1" step="0.001">
            </div>
            <div class="param-group">
              <label class="param-label" for="ilsqrMaxIter">Max Iterations</label>
              <input type="number" id="ilsqrMaxIter" value="50" min="10" max="200" step="10">
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="resetPipelineSettings">Reset Defaults</button>
        <button class="btn btn-primary" id="savePipelineSettings">Save Settings</button>
      </div>
    </div>
  </div>

  <!-- BET Settings Modal -->
  <div class="modal-overlay" id="betSettingsModal">
    <div class="modal">
      <div class="modal-header">
        <h3>BET Settings</h3>
        <button class="modal-close" id="closeBetSettings">&times;</button>
      </div>
      <div class="modal-body">
        <div class="settings-section">
          <h4>Brain Extraction Parameters</h4>
          <div class="param-group">
            <label class="param-label" for="betFractionalIntensity">Fractional Intensity</label>
            <div class="param-hint">Smaller values give larger brain estimate (0.0-1.0)</div>
            <input type="range" id="betFractionalIntensity" min="0.1" max="0.9" value="0.5" step="0.05" class="threshold-slider">
            <div class="param-value-display"><span id="betFractionalIntensityValue">0.5</span></div>
          </div>
          <div class="param-group">
            <label class="param-label" for="betIterations">Iterations</label>
            <div class="param-hint">More iterations = smoother result but slower (100-2000)</div>
            <input type="number" id="betIterations" value="1000" min="100" max="2000" step="100">
          </div>
          <div class="param-group">
            <label class="param-label" for="betSubdivisions">Mesh Subdivisions</label>
            <div class="param-hint">3 = 642 vertices, 4 = 2562 vertices, 5 = 10242 vertices</div>
            <input type="number" id="betSubdivisions" value="4" min="2" max="5" step="1">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="resetBetSettings">Reset Defaults</button>
        <button class="btn btn-primary" id="runBetWithSettings">Run BET</button>
      </div>
    </div>
  </div>

  <!-- Citations Modal -->
  <div class="modal-overlay" id="citationsModal">
    <div class="modal citations-modal">
      <div class="modal-header">
        <h3>Citations</h3>
        <button class="modal-close" id="closeCitations">&times;</button>
      </div>
      <div class="modal-body">
        <div class="citation-section citation-primary">
          <div class="citation-item">
            <strong>QSMbly</strong>
            <span class="citation-ref">Code: <a href="https://github.com/astewartau/qsmbly" target="_blank" rel="noopener">GitHub</a></span>
            <p>Stewart, A.W. (2026). "QSMbly: Browser-based Quantitative Susceptibility Mapping."</p>
            <a href="https://github.com/astewartau/qsmbly" target="_blank" rel="noopener">https://github.com/astewartau/qsmbly</a>
          </div>
        </div>

        <p class="citations-intro">QSMbly implements algorithms from the following publications. Please cite the relevant papers if you use these methods in your research.</p>

        <div class="citation-section">
          <h4>Brain Extraction</h4>
          <div class="citation-item">
            <strong>BET (Brain Extraction Tool)</strong>
            <span class="citation-ref">Code: <a href="https://github.com/Bostrix/FSL-BET2" target="_blank" rel="noopener">FSL-BET2</a></span>
            <p>Smith, S.M. (2002). "Fast robust automated brain extraction." <em>Human Brain Mapping</em>, 17(3):143-155.</p>
            <a href="https://doi.org/10.1002/hbm.10062" target="_blank" rel="noopener">DOI: 10.1002/hbm.10062</a>
          </div>
        </div>

        <div class="citation-section">
          <h4>Phase Unwrapping</h4>
          <div class="citation-item">
            <strong>ROMEO</strong>
            <span class="citation-ref">Code: <a href="https://github.com/korbinian90/MriResearchTools.jl" target="_blank" rel="noopener">MriResearchTools.jl</a></span>
            <p>Dymerska, B., Eckstein, K., Bachrata, B., Siow, B., Trattnig, S., Shmueli, K., Robinson, S.D. (2021). "Phase Unwrapping with a Rapid Opensource Minimum Spanning TreE AlgOrithm (ROMEO)." <em>Magnetic Resonance in Medicine</em>, 85(4):2294-2308.</p>
            <a href="https://doi.org/10.1002/mrm.28563" target="_blank" rel="noopener">DOI: 10.1002/mrm.28563</a>
          </div>
          <div class="citation-item">
            <strong>Laplacian Phase Unwrapping</strong>
            <span class="citation-ref">Code: <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener">QSM.jl</a></span>
            <p>Schofield, M.A., Zhu, Y. (2003). "Fast phase unwrapping algorithm for interferometric applications." <em>Optics Letters</em>, 28(14):1194-1196.</p>
            <a href="https://doi.org/10.1364/OL.28.001194" target="_blank" rel="noopener">DOI: 10.1364/OL.28.001194</a>
          </div>
        </div>

        <div class="citation-section">
          <h4>Multi-Echo Processing</h4>
          <div class="citation-item">
            <strong>MCPC-3D-S (ASPIRE)</strong>
            <span class="citation-ref">Code: <a href="https://github.com/korbinian90/MriResearchTools.jl" target="_blank" rel="noopener">MriResearchTools.jl</a></span>
            <p>Eckstein, K., Dymerska, B., Bachrata, B., Bogner, W., Poljanc, K., Trattnig, S., Robinson, S.D. (2018). "Computationally Efficient Combination of Multi-channel Phase Data From Multi-echo Acquisitions (ASPIRE)." <em>Magnetic Resonance in Medicine</em>, 79:2996-3006.</p>
            <a href="https://doi.org/10.1002/mrm.26963" target="_blank" rel="noopener">DOI: 10.1002/mrm.26963</a>
          </div>
          <div class="citation-item">
            <strong>Multi-Echo B0 Estimation</strong>
            <span class="citation-ref">Code: <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener">QSM.jl</a>, <a href="https://github.com/wtsyeda/QSMART" target="_blank" rel="noopener">QSMART</a></span>
            <p>Linear fit across echo times for B0 field estimation.</p>
          </div>
          <div class="citation-item">
            <strong>Bias Field Correction</strong>
            <span class="citation-ref">Code: <a href="https://github.com/korbinian90/MriResearchTools.jl" target="_blank" rel="noopener">MriResearchTools.jl</a></span>
            <p>Eckstein, K., Trattnig, S., Robinson, S.D. (2019). "A Simple Homogeneity Correction for Neuroimaging at 7T." <em>Proc. ISMRM 27th Annual Meeting</em>.</p>
          </div>
        </div>

        <div class="citation-section">
          <h4>Background Field Removal</h4>
          <div class="citation-item">
            <strong>V-SHARP</strong>
            <span class="citation-ref">Code: <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener">QSM.jl</a></span>
            <p>Wu, B., Li, W., Guidon, A., Liu, C. (2012). "Whole brain susceptibility mapping using compressed sensing." <em>Magnetic Resonance in Medicine</em>, 67(1):137-147.</p>
            <a href="https://doi.org/10.1002/mrm.23000" target="_blank" rel="noopener">DOI: 10.1002/mrm.23000</a>
          </div>
          <div class="citation-item">
            <strong>SHARP</strong>
            <span class="citation-ref">Code: <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener">QSM.jl</a></span>
            <p>Schweser, F., Deistung, A., Lehr, B.W., Reichenbach, J.R. (2011). "Quantitative imaging of intrinsic magnetic tissue properties using MRI signal phase." <em>NeuroImage</em>, 54(4):2789-2807.</p>
            <a href="https://doi.org/10.1016/j.neuroimage.2010.10.070" target="_blank" rel="noopener">DOI: 10.1016/j.neuroimage.2010.10.070</a>
          </div>
          <div class="citation-item">
            <strong>iSMV</strong>
            <span class="citation-ref">Code: <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener">QSM.jl</a></span>
            <p>Wen, Y., Zhou, D., Liu, T., Spincemaille, P., Wang, Y. (2014). "An iterative spherical mean value method for background field removal in MRI." <em>Magnetic Resonance in Medicine</em>, 72(4):1065-1071.</p>
            <a href="https://doi.org/10.1002/mrm.24998" target="_blank" rel="noopener">DOI: 10.1002/mrm.24998</a>
          </div>
          <div class="citation-item">
            <strong>PDF</strong>
            <span class="citation-ref">Code: <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener">QSM.jl</a></span>
            <p>Liu, T., Khalidov, I., de Rochefort, L., Spincemaille, P., Liu, J., Tsiouris, A.J., Wang, Y. (2011). "A novel background field removal method for MRI using projection onto dipole fields." <em>NMR in Biomedicine</em>, 24(9):1129-1136.</p>
            <a href="https://doi.org/10.1002/nbm.1670" target="_blank" rel="noopener">DOI: 10.1002/nbm.1670</a>
          </div>
          <div class="citation-item">
            <strong>LBV</strong>
            <span class="citation-ref">Code: <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener">QSM.jl</a></span>
            <p>Zhou, D., Liu, T., Spincemaille, P., Wang, Y. (2014). "Background field removal by solving the Laplacian boundary value problem." <em>NMR in Biomedicine</em>, 27(3):312-319.</p>
            <a href="https://doi.org/10.1002/nbm.3064" target="_blank" rel="noopener">DOI: 10.1002/nbm.3064</a>
          </div>
          <div class="citation-item">
            <strong>SDF (for QSMART)</strong>
            <span class="citation-ref">Code: <a href="https://github.com/wtsyeda/QSMART" target="_blank" rel="noopener">QSMART</a></span>
            <p>Yaghmaie, N., Syeda, W., et al. (2021). "QSMART: Quantitative Susceptibility Mapping Artifact Reduction Technique." <em>NeuroImage</em>, 231:117701.</p>
            <a href="https://doi.org/10.1016/j.neuroimage.2020.117701" target="_blank" rel="noopener">DOI: 10.1016/j.neuroimage.2020.117701</a>
          </div>
        </div>

        <div class="citation-section">
          <h4>Dipole Inversion</h4>
          <div class="citation-item">
            <strong>TKD / TSVD</strong>
            <span class="citation-ref">Code: <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener">QSM.jl</a></span>
            <p>Shmueli, K., de Zwart, J.A., van Gelderen, P., Li, T.Q., Dodd, S.J., Duyn, J.H. (2009). "Magnetic susceptibility mapping of brain tissue in vivo using MRI phase data." <em>Magnetic Resonance in Medicine</em>, 62(6):1510-1522.</p>
            <a href="https://doi.org/10.1002/mrm.22135" target="_blank" rel="noopener">DOI: 10.1002/mrm.22135</a>
          </div>
          <div class="citation-item">
            <strong>Tikhonov</strong>
            <span class="citation-ref">Code: <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener">QSM.jl</a></span>
            <p>Bilgic, B., et al. (2014). "Fast image reconstruction with L2-regularization." <em>Journal of Magnetic Resonance Imaging</em>, 40(1):181-191.</p>
            <a href="https://doi.org/10.1002/jmri.24365" target="_blank" rel="noopener">DOI: 10.1002/jmri.24365</a>
          </div>
          <div class="citation-item">
            <strong>TV-ADMM</strong>
            <span class="citation-ref">Code: <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener">QSM.jl</a></span>
            <p>Bilgic, B., Fan, A.P., Polimeni, J.R., et al. (2014). "Fast quantitative susceptibility mapping with L1-regularization and automatic parameter selection." <em>Magnetic Resonance in Medicine</em>, 72(5):1444-1459.</p>
            <a href="https://doi.org/10.1002/mrm.25029" target="_blank" rel="noopener">DOI: 10.1002/mrm.25029</a>
          </div>
          <div class="citation-item">
            <strong>RTS (Rapid Two-Step)</strong>
            <span class="citation-ref">Code: <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener">QSM.jl</a></span>
            <p>Kames, C., Wiggermann, V., Rauscher, A. (2018). "Rapid two-step dipole inversion for susceptibility mapping with sparsity priors." <em>NeuroImage</em>, 167:276-283.</p>
            <a href="https://doi.org/10.1016/j.neuroimage.2017.11.018" target="_blank" rel="noopener">DOI: 10.1016/j.neuroimage.2017.11.018</a>
          </div>
          <div class="citation-item">
            <strong>NLTV (Nonlinear TV)</strong>
            <span class="citation-ref">Code: <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener">QSM.jl</a></span>
            <p>Kames, C., Wiggermann, V., Rauscher, A. (2018). "Rapid two-step dipole inversion for susceptibility mapping with sparsity priors." <em>NeuroImage</em>, 167:276-283.</p>
            <a href="https://doi.org/10.1016/j.neuroimage.2017.11.018" target="_blank" rel="noopener">DOI: 10.1016/j.neuroimage.2017.11.018</a>
          </div>
          <div class="citation-item">
            <strong>MEDI</strong>
            <span class="citation-ref">Code: <a href="https://github.com/huawu02/MEDI_toolbox" target="_blank" rel="noopener">MEDI_toolbox</a></span>
            <p>Liu, T., Liu, J., de Rochefort, L., et al. (2011). "Morphology enabled dipole inversion (MEDI) from a single-angle acquisition." <em>Magnetic Resonance in Medicine</em>, 66(3):777-783.</p>
            <a href="https://doi.org/10.1002/mrm.22816" target="_blank" rel="noopener">DOI: 10.1002/mrm.22816</a>
          </div>
          <div class="citation-item">
            <strong>iLSQR</strong>
            <span class="citation-ref">Code: <a href="https://github.com/kamesy/QSM.m" target="_blank" rel="noopener">QSM.m</a></span>
            <p>Li, W., Wang, N., Yu, F., et al. (2015). "A method for estimating and removing streaking artifacts in quantitative susceptibility mapping." <em>NeuroImage</em>, 108:111-122.</p>
            <a href="https://doi.org/10.1016/j.neuroimage.2014.12.043" target="_blank" rel="noopener">DOI: 10.1016/j.neuroimage.2014.12.043</a>
          </div>
          <div class="citation-item">
            <strong>TGV</strong>
            <span class="citation-ref">Code: <a href="https://github.com/korbinian90/QuantitativeSusceptibilityMappingTGV.jl" target="_blank" rel="noopener">QuantitativeSusceptibilityMappingTGV.jl</a></span>
            <p>Langkammer, C., Bredies, K., Poser, B.A., et al. (2015). "Fast quantitative susceptibility mapping using 3D EPI and total generalized variation." <em>NeuroImage</em>, 111:622-630.</p>
            <a href="https://doi.org/10.1016/j.neuroimage.2015.02.041" target="_blank" rel="noopener">DOI: 10.1016/j.neuroimage.2015.02.041</a>
            <p style="margin-top: 4px;">Chatnuntawech, I., McDaniel, P., et al. (2017). "Single-step quantitative susceptibility mapping with variational penalties." <em>NMR in Biomedicine</em>, 30(4):e3570.</p>
            <a href="https://doi.org/10.1002/nbm.3570" target="_blank" rel="noopener">DOI: 10.1002/nbm.3570</a>
          </div>
        </div>

        <div class="citation-section">
          <h4>QSMART Pipeline</h4>
          <div class="citation-item">
            <strong>QSMART (Two-Stage Reconstruction)</strong>
            <span class="citation-ref">Code: <a href="https://github.com/wtsyeda/QSMART" target="_blank" rel="noopener">QSMART</a></span>
            <p>Yaghmaie, N., Syeda, W., Wu, C., Zhang, Y., Zhang, T., Burrows, E.L., Moffat, B.A., Wright, D.K., Glarin, R., Kolbe, S., Johnston, L.A. (2021). "QSMART: Quantitative Susceptibility Mapping Artifact Reduction Technique." <em>NeuroImage</em>, 231:117701.</p>
            <a href="https://doi.org/10.1016/j.neuroimage.2020.117701" target="_blank" rel="noopener">DOI: 10.1016/j.neuroimage.2020.117701</a>
          </div>
        </div>

        <div class="citation-section">
          <h4>Utility Algorithms</h4>
          <div class="citation-item">
            <strong>Frangi Vesselness Filter</strong>
            <span class="citation-ref">Code: <a href="https://www.mathworks.com/matlabcentral/fileexchange/24409-hessian-based-frangi-vesselness-filter" target="_blank" rel="noopener">MATLAB File Exchange</a> (Dirk-Jan Kroon)</span>
            <p>Frangi, A.F., Niessen, W.J., Vincken, K.L., Viergever, M.A. (1998). "Multiscale vessel enhancement filtering." <em>MICCAI'98</em>, LNCS vol 1496, 130-137.</p>
            <a href="https://doi.org/10.1007/BFb0056195" target="_blank" rel="noopener">DOI: 10.1007/BFb0056195</a>
          </div>
          <div class="citation-item">
            <strong>Surface Curvature Calculation</strong>
            <span class="citation-ref">Code: <a href="https://www.mathworks.com/matlabcentral/fileexchange/61136-curvatures" target="_blank" rel="noopener">MATLAB File Exchange</a> (Alireza Dastan)</span>
            <p>Meyer, M., Desbrun, M., Schroder, P., Barr, A.H. (2003). "Discrete Differential-Geometry Operators for Triangulated 2-Manifolds." <em>Visualization and Mathematics III</em>, 35-57.</p>
            <a href="https://doi.org/10.1007/978-3-662-05105-4_2" target="_blank" rel="noopener">DOI: 10.1007/978-3-662-05105-4_2</a>
          </div>
        </div>

        <div class="citation-section">
          <h4>QSM Review Papers</h4>
          <div class="citation-item">
            <p>Deistung, A., Schweser, F., Reichenbach, J.R. (2017). "Overview of quantitative susceptibility mapping." <em>NMR in Biomedicine</em>, 30(4):e3569.</p>
            <a href="https://doi.org/10.1002/nbm.3569" target="_blank" rel="noopener">DOI: 10.1002/nbm.3569</a>
          </div>
          <div class="citation-item">
            <p>Schweser, F., Deistung, A., Reichenbach, J.R. (2016). "Foundations of MRI phase imaging and processing for Quantitative Susceptibility Mapping (QSM)." <em>Zeitschrift fur Medizinische Physik</em>, 26(1):6-34.</p>
            <a href="https://doi.org/10.1016/j.zemedi.2015.10.002" target="_blank" rel="noopener">DOI: 10.1016/j.zemedi.2015.10.002</a>
          </div>
          <div class="citation-item">
            <p>Harada, T., Kudo, K., Fujima, N., et al. (2022). "Quantitative Susceptibility Mapping: Basic Methods and Clinical Applications." <em>RadioGraphics</em>, 42(4):1161-1176.</p>
            <a href="https://doi.org/10.1148/rg.210054" target="_blank" rel="noopener">DOI: 10.1148/rg.210054</a>
          </div>
        </div>

        <div class="citation-section">
          <h4>Reference Implementations</h4>
          <p class="citations-intro" style="margin-bottom: var(--space-sm);">The following repositories were used as references:</p>
          <div class="ref-list">
            <a href="https://github.com/Bostrix/FSL-BET2" target="_blank" rel="noopener">FSL-BET2</a> - BET brain extraction
          </div>
          <div class="ref-list">
            <a href="https://github.com/korbinian90/MriResearchTools.jl" target="_blank" rel="noopener">MriResearchTools.jl</a> - ROMEO, MCPC-3D-S, Bias correction
          </div>
          <div class="ref-list">
            <a href="https://github.com/huawu02/MEDI_toolbox" target="_blank" rel="noopener">MEDI_toolbox</a> - MEDI
          </div>
          <div class="ref-list">
            <a href="https://github.com/kamesy/QSM.jl" target="_blank" rel="noopener">QSM.jl</a> - Laplacian unwrap, V-SHARP, SHARP, iSMV, PDF, LBV, TKD, TSVD, RTS, NLTV, Tikhonov, TV-ADMM
          </div>
          <div class="ref-list">
            <a href="https://github.com/kamesy/QSM.m" target="_blank" rel="noopener">QSM.m</a> - iLSQR
          </div>
          <div class="ref-list">
            <a href="https://github.com/wtsyeda/QSMART" target="_blank" rel="noopener">QSMART</a> - SDF, Frangi filter, curvature, two-stage pipeline
          </div>
          <div class="ref-list">
            <a href="https://github.com/korbinian90/QuantitativeSusceptibilityMappingTGV.jl" target="_blank" rel="noopener">QuantitativeSusceptibilityMappingTGV.jl</a> - TGV-QSM
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main App Module (imports config and utilities internally) -->
  <script type="module" src="js/qsm-app-romeo.js"></script>

  <!-- Additional UI Interactions -->
  <script>
    // Accordion toggle for sidebar sections
    function toggleSection(section) {
      const wasCollapsed = section.classList.contains('collapsed');
      const isResultsSection = section.id === 'stage-buttons';

      // Close all other sections (accordion behavior), except Results which can stay open
      document.querySelectorAll('.sidebar-section:not(.hidden)').forEach(s => {
        const isResults = s.id === 'stage-buttons';
        // Don't close Results section when opening other sections
        // Don't close other sections when toggling Results
        if (s !== section && !s.classList.contains('collapsed') && !isResults && !isResultsSection) {
          s.classList.add('collapsed');
        }
      });

      // Toggle the clicked section
      if (wasCollapsed) {
        section.classList.remove('collapsed');
      } else {
        section.classList.add('collapsed');
      }
    }

    // View tab switching
    document.querySelectorAll('.view-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        if (!window.app || !window.app.nv) return;

        document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        const view = tab.dataset.view;
        const nv = window.app.nv;

        switch(view) {
          case 'multiplanar':
            nv.setSliceType(nv.sliceTypeMultiplanar);
            break;
          case 'axial':
            nv.setSliceType(nv.sliceTypeAxial);
            break;
          case 'coronal':
            nv.setSliceType(nv.sliceTypeCoronal);
            break;
          case 'sagittal':
            nv.setSliceType(nv.sliceTypeSagittal);
            break;
          case 'render':
            nv.setSliceType(nv.sliceTypeRender);
            break;
        }
      });
    });

    // Colormap selection
    document.getElementById('colormapSelect').addEventListener('change', (e) => {
      if (!window.app || !window.app.nv) return;
      const nv = window.app.nv;
      if (!nv.volumes || nv.volumes.length === 0 || !nv.volumes[0]) return;
      try {
        nv.volumes[0].colormap = e.target.value;
        nv.updateGLVolume();
      } catch (err) {
        console.warn('Could not set colormap:', err);
      }
    });

    // Colorbar toggle
    document.getElementById('colorbarToggle').addEventListener('change', (e) => {
      if (!window.app || !window.app.nv) return;
      const nv = window.app.nv;
      nv.opts.isColorbar = e.target.checked;
      nv.drawScene();
    });

    // Crosshair toggle
    document.getElementById('crosshairToggle').addEventListener('change', (e) => {
      if (!window.app || !window.app.nv) return;
      const nv = window.app.nv;
      nv.setCrosshairWidth(e.target.checked ? 0.75 : 0);
    });

    // Window controls (min/max intensity) with dual range slider
    const windowState = { dataMin: 0, dataMax: 100, currentMin: 0, currentMax: 100 };

    function updateRangeHighlight() {
      const rangeMin = document.getElementById('rangeMin');
      const rangeMax = document.getElementById('rangeMax');
      const selected = document.getElementById('rangeSelected');
      const minPercent = ((rangeMin.value - rangeMin.min) / (rangeMin.max - rangeMin.min)) * 100;
      const maxPercent = ((rangeMax.value - rangeMax.min) / (rangeMax.max - rangeMax.min)) * 100;
      selected.style.left = minPercent + '%';
      selected.style.width = (maxPercent - minPercent) + '%';
    }

    function sliderToValue(sliderVal) {
      return windowState.dataMin + (sliderVal / 100) * (windowState.dataMax - windowState.dataMin);
    }

    function valueToSlider(val) {
      if (windowState.dataMax === windowState.dataMin) return 50;
      return ((val - windowState.dataMin) / (windowState.dataMax - windowState.dataMin)) * 100;
    }

    function applyWindow(minVal, maxVal) {
      if (!window.app || !window.app.nv || !window.app.nv.volumes.length) return;
      const vol = window.app.nv.volumes[0];
      vol.cal_min = minVal;
      vol.cal_max = maxVal;
      window.app.nv.updateGLVolume();
    }

    function syncFromSliders() {
      const minSlider = document.getElementById('rangeMin');
      const maxSlider = document.getElementById('rangeMax');
      // Prevent crossover
      if (parseInt(minSlider.value) > parseInt(maxSlider.value) - 1) {
        minSlider.value = parseInt(maxSlider.value) - 1;
      }
      if (parseInt(maxSlider.value) < parseInt(minSlider.value) + 1) {
        maxSlider.value = parseInt(minSlider.value) + 1;
      }
      const minVal = sliderToValue(parseFloat(minSlider.value));
      const maxVal = sliderToValue(parseFloat(maxSlider.value));
      document.getElementById('windowMin').value = minVal.toFixed(2);
      document.getElementById('windowMax').value = maxVal.toFixed(2);
      updateRangeHighlight();
      applyWindow(minVal, maxVal);
    }

    function syncFromInputs() {
      const minInput = document.getElementById('windowMin');
      const maxInput = document.getElementById('windowMax');
      let minVal = parseFloat(minInput.value) || windowState.dataMin;
      let maxVal = parseFloat(maxInput.value) || windowState.dataMax;
      // Clamp to data range
      minVal = Math.max(windowState.dataMin, Math.min(windowState.dataMax, minVal));
      maxVal = Math.max(windowState.dataMin, Math.min(windowState.dataMax, maxVal));
      if (minVal > maxVal) { const t = minVal; minVal = maxVal; maxVal = t; }
      document.getElementById('rangeMin').value = valueToSlider(minVal);
      document.getElementById('rangeMax').value = valueToSlider(maxVal);
      updateRangeHighlight();
      applyWindow(minVal, maxVal);
    }

    document.getElementById('rangeMin').addEventListener('input', syncFromSliders);
    document.getElementById('rangeMax').addEventListener('input', syncFromSliders);
    document.getElementById('windowMin').addEventListener('change', syncFromInputs);
    document.getElementById('windowMax').addEventListener('change', syncFromInputs);

    document.getElementById('resetWindow').addEventListener('click', () => {
      if (!window.app || !window.app.nv || !window.app.nv.volumes.length) return;
      const vol = window.app.nv.volumes[0];
      // Use NiiVue's built-in robust (percentile-based) min/max
      const min = vol.robust_min ?? vol.global_min;
      const max = vol.robust_max ?? vol.global_max;
      windowState.currentMin = min;
      windowState.currentMax = max;
      document.getElementById('windowMin').value = min.toFixed(2);
      document.getElementById('windowMax').value = max.toFixed(2);
      document.getElementById('rangeMin').value = valueToSlider(min);
      document.getElementById('rangeMax').value = valueToSlider(max);
      updateRangeHighlight();
      applyWindow(min, max);
    });

    // Update window controls when a new volume is loaded
    function initWindowControls() {
      if (!window.app || !window.app.nv || !window.app.nv.volumes.length) return;
      const vol = window.app.nv.volumes[0];
      windowState.dataMin = vol.global_min;
      windowState.dataMax = vol.global_max;
      windowState.currentMin = vol.cal_min;
      windowState.currentMax = vol.cal_max;
      document.getElementById('windowMin').value = vol.cal_min.toFixed(2);
      document.getElementById('windowMax').value = vol.cal_max.toFixed(2);
      document.getElementById('rangeMin').value = valueToSlider(vol.cal_min);
      document.getElementById('rangeMax').value = valueToSlider(vol.cal_max);
      updateRangeHighlight();
    }

    // Watch for volume changes
    const volumeObserver = setInterval(() => {
      if (window.app && window.app.nv && window.app.nv.volumes.length > 0) {
        const vol = window.app.nv.volumes[0];
        if (vol.global_min !== windowState.dataMin || vol.global_max !== windowState.dataMax) {
          initWindowControls();
        }
      }
    }, 500);

    // Interpolation checkbox (disabled by default)
    document.getElementById('interpolation').addEventListener('change', (e) => {
      if (!window.app || !window.app.nv) return;
      window.app.nv.setInterpolation(!e.target.checked); // checked = smooth, unchecked = nearest
      window.app.nv.drawScene();
    });

    // Initialize interpolation off (nearest neighbor) when app loads
    const initInterp = setInterval(() => {
      if (window.app && window.app.nv) {
        window.app.nv.setInterpolation(true); // true = nearest neighbor (no interpolation)
        clearInterval(initInterp);
      }
    }, 500);

    // Clear console
    document.getElementById('clearConsole').addEventListener('click', () => {
      const consoleOutput = document.getElementById('consoleOutput');
      if (consoleOutput) consoleOutput.innerHTML = '';
    });

    // Drag and drop enhancement
    ['magnitudeDrop', 'phaseDrop', 'jsonDrop'].forEach(id => {
      const dropZone = document.getElementById(id);
      if (!dropZone) return;

      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const input = dropZone.querySelector('input[type="file"]');
        if (input && e.dataTransfer.files.length) {
          input.files = e.dataTransfer.files;
          input.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
    });

    // =========================================================================
    // Phase Processing UI Controls
    // =========================================================================

    // Phase offset method (MCPC-3D-S / None) controls
    const phaseOffsetMethod = document.getElementById('phaseOffsetMethod');
    const mcpc3dsSettings = document.getElementById('mcpc3dsSettings');
    const unwrapMethod = document.getElementById('unwrapMethod');
    const unwrapLockedHint = document.getElementById('unwrapLockedHint');
    const romeoSettings = document.getElementById('romeoSettings');
    const laplacianSettings = document.getElementById('laplacianSettings');

    function updatePhaseOffsetUI() {
      const method = phaseOffsetMethod.value;
      const isMcpc3ds = method === 'mcpc3ds';

      // Show/hide MCPC-3D-S settings
      mcpc3dsSettings.style.display = isMcpc3ds ? 'block' : 'none';

      // Lock unwrap method to ROMEO when MCPC-3D-S is selected
      if (isMcpc3ds) {
        unwrapMethod.value = 'romeo';
        unwrapMethod.disabled = true;
        unwrapLockedHint.style.display = 'block';
      } else {
        unwrapMethod.disabled = false;
        unwrapLockedHint.style.display = 'none';
      }

      updateUnwrapUI();
    }

    function updateUnwrapUI() {
      const method = unwrapMethod.value;
      romeoSettings.style.display = method === 'romeo' ? 'block' : 'none';
      laplacianSettings.style.display = method === 'laplacian' ? 'block' : 'none';
    }

    phaseOffsetMethod.addEventListener('change', updatePhaseOffsetUI);
    unwrapMethod.addEventListener('change', updateUnwrapUI);

    // Field calculation method controls
    const fieldCalculationMethod = document.getElementById('fieldCalculationMethod');
    const weightedAvgSettings = document.getElementById('weightedAvgSettings');
    const linearFitSettings = document.getElementById('linearFitSettings');

    function updateFieldCalculationUI() {
      const method = fieldCalculationMethod.value;
      weightedAvgSettings.style.display = method === 'weighted_avg' ? 'block' : 'none';
      linearFitSettings.style.display = method === 'linear_fit' ? 'block' : 'none';
    }

    fieldCalculationMethod.addEventListener('change', updateFieldCalculationUI);

    // Single-echo unwrap method controls
    const singleEchoUnwrapMethod = document.getElementById('singleEchoUnwrapMethod');
    const singleEchoRomeoSettings = document.getElementById('singleEchoRomeoSettings');
    const singleEchoLaplacianSettings = document.getElementById('singleEchoLaplacianSettings');

    function updateSingleEchoUnwrapUI() {
      const method = singleEchoUnwrapMethod.value;
      singleEchoRomeoSettings.style.display = method === 'romeo' ? 'block' : 'none';
      singleEchoLaplacianSettings.style.display = method === 'laplacian' ? 'block' : 'none';
    }

    singleEchoUnwrapMethod.addEventListener('change', updateSingleEchoUnwrapUI);

    // Initialize UI state
    updatePhaseOffsetUI();
    updateFieldCalculationUI();
    updateSingleEchoUnwrapUI();

  </script>

  <style>
    /* Additional styles for stage buttons grid */
    .stage-buttons-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-xs);
    }

    .stage-item {
      display: flex;
      gap: 2px;
    }

    .stage-item .stage-tab {
      flex: 1;
      font-size: 0.7rem;
      padding: var(--space-xs);
    }

    .stage-item .download-btn {
      padding: var(--space-xs);
      opacity: 0.6;
    }

    .stage-item .download-btn:hover {
      opacity: 1;
    }

    .stage-item .download-btn svg {
      width: 12px;
      height: 12px;
    }

    /* Mask preview buttons */
    .mask-preview-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-xs);
      margin-top: var(--space-sm);
    }

    .mask-preview-buttons .btn {
      font-size: 0.7rem;
      padding: var(--space-xs) var(--space-sm);
    }

    /* Mask operation buttons */
    .mask-op-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-xs);
    }

    .mask-op-buttons .btn {
      font-size: 0.7rem;
      padding: var(--space-xs) var(--space-sm);
    }

    /* Drawing controls */
    .drawing-controls {
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
    }

    .brush-mode-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: var(--space-xs);
    }

    .brush-mode-buttons .btn {
      font-size: 0.65rem;
      padding: var(--space-xs);
    }

    .brush-mode-buttons .btn.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    .brush-size-control {
      padding: var(--space-xs) 0;
    }

    .drawing-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-xs);
    }

    .drawing-actions .btn {
      font-size: 0.7rem;
    }

    /* Threshold slider */
    .threshold-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-xs);
    }

    .threshold-slider {
      width: 100%;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      background: var(--color-border);
      border-radius: 3px;
      outline: none;
      cursor: pointer;
    }

    .threshold-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      background: var(--color-primary);
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .threshold-slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    .threshold-slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: var(--color-primary);
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }

    .threshold-slider:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .threshold-slider:disabled::-webkit-slider-thumb {
      background: var(--color-text-muted);
      cursor: not-allowed;
    }

    .threshold-slider:disabled::-moz-range-thumb {
      background: var(--color-text-muted);
      cursor: not-allowed;
    }

    /* Compact preview buttons */
    .preview-buttons {
      display: flex;
      gap: var(--space-xs);
      margin-top: var(--space-sm);
    }

    .preview-buttons .btn {
      flex: 1;
      font-size: 0.7rem;
      padding: var(--space-xs) var(--space-sm);
    }

    .preview-buttons .btn svg {
      width: 12px;
      height: 12px;
    }

    /* Inline param with unit */
    .param-inline {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .param-inline input {
      flex: 1;
    }

    .param-inline .unit {
      font-size: 0.7rem;
      color: var(--color-text-muted);
      white-space: nowrap;
    }

    /* Modal styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(2px);
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-border);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      max-width: 500px;
      width: 90%;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-md) var(--space-lg);
      border-bottom: 1px solid var(--color-border);
    }

    .modal-header h3 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--color-text);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--color-text-muted);
      padding: 0;
      line-height: 1;
      transition: color 0.15s;
    }

    .modal-close:hover {
      color: var(--color-text);
    }

    .modal-body {
      padding: var(--space-lg);
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: var(--space-sm);
      padding: var(--space-md) var(--space-lg);
      border-top: 1px solid var(--color-border);
      background: var(--color-surface-elevated);
    }

    .settings-section {
      margin-bottom: var(--space-lg);
    }

    .settings-section:last-child {
      margin-bottom: 0;
    }

    .settings-section h4 {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--color-primary);
      margin: 0 0 var(--space-sm) 0;
      padding-bottom: var(--space-xs);
      border-bottom: 1px solid var(--color-border);
    }

    .param-hint {
      font-size: 0.7rem;
      color: var(--color-text-muted);
      margin-bottom: var(--space-xs);
    }

    .param-value-display {
      text-align: center;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--color-primary);
      margin-top: var(--space-xs);
    }

    /* Method settings container */
    .method-settings {
      margin-top: var(--space-sm);
      padding: var(--space-sm);
      background: var(--color-surface-elevated);
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border);
    }

    .method-settings .param-group:last-child {
      margin-bottom: 0;
    }

    .method-links {
      display: flex;
      gap: var(--space-xs);
      margin-bottom: var(--space-sm);
    }

    .method-links a {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      color: var(--color-text-muted);
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      transition: all 0.15s;
      font-size: 0.7rem;
      text-decoration: none;
    }

    .method-links a:hover {
      color: var(--color-primary);
      border-color: var(--color-primary);
      background: var(--color-surface-alt);
    }

    /* Checkbox styling */
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      cursor: pointer;
      font-size: 0.85rem;
    }

    .checkbox-label input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: var(--color-primary);
    }

    /* Window controls */
    .viewer-actions {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      flex-wrap: wrap;
    }

    .window-controls {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
    }

    .window-input {
      width: 80px;
      max-width: 80px;
      padding: 3px 3px;
      font-size: 0.7rem;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      background: var(--color-surface);
      color: var(--color-text);
      text-align: center;
      -moz-appearance: textfield;
    }

    .window-input::-webkit-outer-spin-button,
    .window-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .window-input::placeholder {
      color: var(--color-text-muted);
      font-size: 0.65rem;
    }

    .window-controls .btn-sm {
      padding: 3px 8px;
      font-size: 0.65rem;
    }

    /* Dual range slider */
    .range-slider-container {
      position: relative;
      width: 135px;
      height: 20px;
      display: flex;
      align-items: center;
    }

    .range-track {
      position: absolute;
      width: 100%;
      height: 4px;
      background: var(--color-border);
      border-radius: 2px;
      pointer-events: none;
      z-index: 1;
    }

    .range-selected {
      position: absolute;
      height: 4px;
      background: var(--color-primary);
      border-radius: 2px;
      pointer-events: none;
      z-index: 2;
    }

    .range-slider {
      position: absolute;
      width: 100%;
      height: 20px;
      -webkit-appearance: none;
      appearance: none;
      background: transparent;
      pointer-events: none;
      margin: 0;
      z-index: 3;
    }

    .range-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      background: var(--color-primary);
      border-radius: 50%;
      cursor: pointer;
      pointer-events: auto;
      border: 2px solid white;
      box-shadow: 0 1px 4px rgba(0,0,0,0.4);
      position: relative;
      z-index: 10;
    }

    .range-slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: var(--color-primary);
      border-radius: 50%;
      cursor: pointer;
      pointer-events: auto;
      border: 2px solid white;
      box-shadow: 0 1px 4px rgba(0,0,0,0.4);
    }

    .range-slider::-webkit-slider-thumb:hover {
      transform: scale(1.15);
    }

    .range-slider::-moz-range-thumb:hover {
      transform: scale(1.15);
    }

    .range-min {
      z-index: 4;
    }

    .range-max {
      z-index: 3;
    }

    .interp-checkbox {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.7rem;
      color: var(--color-text-muted);
      cursor: pointer;
      white-space: nowrap;
    }

    .interp-checkbox input[type="checkbox"] {
      width: 12px;
      height: 12px;
      cursor: pointer;
      accent-color: var(--color-primary);
    }

    .data-units {
      font-size: 0.7rem;
      color: var(--color-primary);
      font-weight: 600;
      white-space: nowrap;
    }

    .data-units:empty {
      display: none;
    }

    /* Header links */
    .header-links {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .header-link {
      color: white;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      transition: opacity 0.15s;
      opacity: 0.8;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .header-link:hover {
      opacity: 1;
    }

    .header-link svg {
      display: block;
    }

    .citation-primary {
      background: var(--color-surface-alt);
      border: 1px solid var(--color-primary);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      margin-bottom: var(--space-md);
    }

    .citation-primary .citation-item {
      margin-bottom: 0;
    }

    .citation-primary strong {
      font-size: 1.1rem;
      color: var(--color-primary);
    }

    /* Citations modal */
    .citations-modal {
      max-width: 700px;
      max-height: 80vh;
    }

    .citations-intro {
      font-size: 0.85rem;
      color: var(--color-text-muted);
      margin: 0 0 var(--space-lg) 0;
      line-height: 1.5;
    }

    .citation-section {
      margin-bottom: var(--space-lg);
    }

    .citation-section h4 {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--color-primary);
      margin: 0 0 var(--space-sm) 0;
      padding-bottom: var(--space-xs);
      border-bottom: 1px solid var(--color-border);
    }

    .citation-item {
      margin-bottom: var(--space-md);
      padding-left: var(--space-sm);
      border-left: 2px solid var(--color-border);
    }

    .citation-item:last-child {
      margin-bottom: 0;
    }

    .citation-item strong {
      display: block;
      font-size: 0.85rem;
      color: var(--color-text);
      margin-bottom: 4px;
    }

    .citation-item p {
      font-size: 0.8rem;
      color: var(--color-text-muted);
      margin: 0 0 4px 0;
      line-height: 1.4;
    }

    .citation-item em {
      font-style: italic;
    }

    .citation-item a {
      font-size: 0.75rem;
      color: var(--color-primary);
      text-decoration: none;
    }

    .citation-item a:hover {
      text-decoration: underline;
    }

    .citation-ref {
      display: block;
      font-size: 0.7rem;
      color: var(--color-text-muted);
      margin-bottom: 4px;
    }

    .citation-ref a {
      color: var(--color-primary);
      text-decoration: none;
    }

    .citation-ref a:hover {
      text-decoration: underline;
    }

    .ref-list {
      font-size: 0.8rem;
      color: var(--color-text-muted);
      margin-bottom: 6px;
      line-height: 1.4;
    }

    .ref-list a {
      color: var(--color-primary);
      text-decoration: none;
      font-weight: 500;
    }

    .ref-list a:hover {
      text-decoration: underline;
    }
  </style>
</body>
</html>
