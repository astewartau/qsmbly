<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QSMbly | Quantitative Susceptibility Mapping</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <!-- Tagify (load before our CSS so we can override) -->
  <link rel="stylesheet" href="https://unpkg.com/@yaireo/tagify/dist/tagify.css">
  <script src="https://unpkg.com/@yaireo/tagify"></script>

  <!-- Our styles last to override -->
  <link rel="stylesheet" href="css/modern-styles.css">

  <!-- NiiVue -->
  <script type="module">
    import { Niivue, NVImage } from "https://unpkg.com/@niivue/niivue@0.57.0/dist/index.js";
    window.Niivue = Niivue;
    window.NVImage = NVImage;
  </script>
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <header class="app-header">
      <div class="logo">
        <div class="logo-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
            <path d="M2 17l10 5 10-5"/>
            <path d="M2 12l10 5 10-5"/>
          </svg>
        </div>
        <h1>QSMbly <span>Quantitative Susceptibility Mapping</span></h1>
      </div>
    </header>

    <!-- Sidebar -->
    <aside class="app-sidebar" id="sidebar">
      <!-- File Upload Section -->
      <section class="sidebar-section">
        <h2 class="section-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          Input Files
        </h2>

        <!-- Magnitude Files -->
        <div class="file-upload-group">
          <label class="file-upload-label">
            Magnitude Images <span class="count" id="magCount"></span>
          </label>
          <div class="upload-group">
            <div class="file-upload-zone file-drop" id="magnitudeDrop">
              <input type="file" id="magnitudeFiles" accept=".nii,.nii.gz" multiple>
              <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              <p class="upload-text file-drop-label"><span>Drop files or click</span></p>
            </div>
            <div class="file-list" id="magnitudeList"></div>
          </div>
        </div>

        <!-- Phase Files -->
        <div class="file-upload-group">
          <label class="file-upload-label">
            Phase Images <span class="count" id="phaseCount"></span>
          </label>
          <div class="upload-group">
            <div class="file-upload-zone file-drop" id="phaseDrop">
              <input type="file" id="phaseFiles" accept=".nii,.nii.gz" multiple>
              <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              <p class="upload-text file-drop-label"><span>Drop files or click</span></p>
            </div>
            <div class="file-list" id="phaseList"></div>
          </div>
        </div>

        <!-- Preview Buttons -->
        <div class="preview-buttons">
          <button class="btn btn-secondary btn-sm" id="vis_magnitude" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
            Mag
          </button>
          <button class="btn btn-secondary btn-sm" id="vis_phase" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
            Phase
          </button>
        </div>
      </section>

      <!-- Parameters Section -->
      <section class="sidebar-section">
        <h2 class="section-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
          </svg>
          Parameters
        </h2>

        <!-- JSON Metadata Upload -->
        <div class="param-group">
          <label class="param-label">
            JSON Metadata <span class="count" id="jsonCount"></span>
          </label>
          <div class="upload-group compact">
            <div class="file-upload-zone file-drop compact" id="jsonDrop">
              <input type="file" id="jsonFiles" accept=".json" multiple>
              <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              <p class="upload-text file-drop-label"><span>Drop files or click</span></p>
            </div>
            <div class="file-list" id="jsonList"></div>
          </div>
        </div>

        <div class="param-group">
          <label class="param-label" for="magField">Field Strength</label>
          <div class="param-inline">
            <input type="number" id="magField" value="7.0" step="0.1" min="0.1">
            <span class="unit">Tesla</span>
          </div>
        </div>

        <div class="param-group">
          <label class="param-label">Echo Times <span class="unit-inline">(ms)</span></label>
          <input type="text" id="echoTimesTagify" placeholder="Type values...">
        </div>
      </section>

      <!-- Mask Threshold Section -->
      <section class="sidebar-section section-disabled" id="maskSection">
        <h2 class="section-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>
          </svg>
          Masking
        </h2>

        <!-- Mask Input Preparation -->
        <div class="param-group">
          <label class="param-label" for="maskInputSource">Mask Input</label>
          <select id="maskInputSource">
            <option value="first_echo">First-echo magnitude</option>
            <option value="combined" selected>Combined magnitude (RSS)</option>
          </select>
        </div>

        <div class="param-group">
          <label class="checkbox-label">
            <input type="checkbox" id="applyBiasCorrection" checked>
            <span>Apply bias correction</span>
          </label>
        </div>

        <button class="btn btn-secondary btn-sm" id="prepareMaskInput" style="width: 100%; margin-bottom: var(--space-sm);" disabled>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/>
          </svg>
          Prepare
        </button>

        <div class="mask-preview-buttons">
          <button class="btn btn-secondary btn-sm" id="previewMask" title="Generate mask from threshold" disabled>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
            Threshold
          </button>
          <button class="btn btn-secondary btn-sm" id="runBET" title="BET brain extraction (slower but more accurate)" disabled>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 8c-2.2 0-4 1.8-4 4s1.8 4 4 4 4-1.8 4-4"/>
            </svg>
            BET
          </button>
        </div>

        <!-- Threshold Slider (enabled only after Threshold button is pressed) -->
        <div class="param-group" id="thresholdSliderGroup" style="margin-top: var(--space-sm);">
          <div class="threshold-header">
            <label class="param-label" for="maskThreshold" id="thresholdLabel">Threshold</label>
            <button class="btn-icon" id="autoThreshold" title="Reset to Otsu threshold" disabled>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 4v6h-6"/>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
              </svg>
            </button>
          </div>
          <input type="range" id="maskThreshold" min="1" max="100" value="15" class="threshold-slider" disabled>
        </div>

        <!-- Morphological Operations -->
        <div class="mask-operations" id="maskOperations" style="display: none; margin-top: var(--space-sm);">
          <label class="param-label" style="margin-bottom: var(--space-xs);">Refine Mask</label>
          <div class="mask-op-buttons">
            <button class="btn btn-secondary btn-sm" id="fillHoles" title="Fill holes inside the mask">
              Fill Holes
            </button>
            <button class="btn btn-secondary btn-sm" id="erodeMask" title="Shrink mask boundaries">
              Erode
            </button>
            <button class="btn btn-secondary btn-sm" id="dilateMask" title="Expand mask boundaries">
              Dilate
            </button>
            <button class="btn btn-secondary btn-sm" id="resetMask" title="Reset to threshold-based mask">
              Reset
            </button>
          </div>

          <!-- Drawing/Painting Tools -->
          <label class="param-label" style="margin-top: var(--space-sm); margin-bottom: var(--space-xs);">Paint Mask</label>
          <div class="drawing-controls">
            <div class="brush-mode-buttons">
              <button class="btn btn-secondary btn-sm" id="enableDrawing" title="Enable brush painting">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                  <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                  <path d="M2 2l7.586 7.586"/>
                </svg>
                Draw
              </button>
              <button class="btn btn-secondary btn-sm" id="brushAdd" title="Add to mask" disabled>
                + Add
              </button>
              <button class="btn btn-secondary btn-sm" id="brushRemove" title="Remove from mask" disabled>
                - Remove
              </button>
            </div>
            <div class="brush-size-control" id="brushSizeControl" style="display: none;">
              <label class="param-label" style="font-size: 0.7rem;">Brush Size: <span id="brushSizeValue">2</span></label>
              <input type="range" id="brushSize" min="1" max="10" value="2" class="threshold-slider">
            </div>
            <div class="drawing-actions" id="drawingActions" style="display: none;">
              <button class="btn btn-secondary btn-sm" id="undoDraw" title="Undo last stroke">
                Undo
              </button>
              <button class="btn btn-primary btn-sm" id="applyDrawing" title="Apply drawing to mask">
                Apply
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Progress & Run Section -->
      <section class="sidebar-section section-disabled" id="pipelineSection">
        <div class="progress-container">
          <div class="progress-header">
            <span class="progress-title">Pipeline Progress</span>
            <span class="progress-value" id="progressText">0%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
          </div>
        </div>

        <div class="run-button-group">
          <button class="btn btn-primary" id="run" disabled>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="5 3 19 12 5 21 5 3"/>
            </svg>
            <span>Run Pipeline</span>
          </button>
          <button class="btn btn-danger" id="cancelPipeline" disabled>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            </svg>
            <span>Cancel</span>
          </button>
        </div>
      </section>

      <!-- Results Section - dynamically populated -->
      <section class="sidebar-section hidden" id="stage-buttons">
        <h2 class="section-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
          Pipeline Results
        </h2>
        <!-- Stage buttons are dynamically added here -->
        <div class="stage-buttons-grid" id="dynamicStageButtons"></div>
      </section>
    </aside>

    <!-- Main Content -->
    <main class="app-main">
      <!-- Viewer Toolbar -->
      <div class="viewer-toolbar">
        <div class="view-tabs">
          <button class="view-tab active" data-view="multiplanar">3-Plane</button>
          <button class="view-tab" data-view="axial">Axial</button>
          <button class="view-tab" data-view="coronal">Coronal</button>
          <button class="view-tab" data-view="sagittal">Sagittal</button>
          <button class="view-tab" data-view="render">3D</button>
        </div>

        <!-- Echo Navigation (hidden when not multi-echo) -->
        <div class="echo-nav" id="echoNav" style="display: none;">
          <button class="btn btn-sm btn-icon" id="echoPrev" title="Previous echo">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
          </button>
          <span class="echo-label" id="echoLabel">Echo 1/1</span>
          <button class="btn btn-sm btn-icon" id="echoNext" title="Next echo">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
              <polyline points="9 18 15 12 9 6"/>
            </svg>
          </button>
        </div>

        <div class="viewer-actions">
          <div class="window-controls">
            <input type="number" id="windowMin" class="window-input" placeholder="min" step="any" title="Window minimum">
            <div class="range-slider-container">
              <input type="range" id="rangeMin" class="range-slider range-min" min="0" max="100" value="0">
              <input type="range" id="rangeMax" class="range-slider range-max" min="0" max="100" value="100">
              <div class="range-track"></div>
              <div class="range-selected" id="rangeSelected"></div>
            </div>
            <input type="number" id="windowMax" class="window-input" placeholder="max" step="any" title="Window maximum">
            <button class="btn btn-sm" id="resetWindow" title="Reset to full range">Auto</button>
          </div>
          <label class="interp-checkbox">
            <input type="checkbox" id="interpolation">
            <span>Interp</span>
          </label>
          <label class="opacity-control" id="overlayOpacityControl" style="display: none;">
            <span>Overlay</span>
            <input type="range" id="overlayOpacity" min="0" max="100" value="50">
            <span id="overlayOpacityValue">50%</span>
          </label>
          <select class="colormap-select" id="colormapSelect">
            <option value="gray">Gray</option>
            <option value="hot">Hot</option>
            <option value="cool">Cool</option>
            <option value="viridis">Viridis</option>
            <option value="plasma">Plasma</option>
          </select>
          <button class="btn btn-sm btn-icon" id="downloadCurrentVolume" title="Download current image as NIfTI" disabled>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- NiiVue Canvas -->
      <div class="viewer-canvas-wrapper">
        <canvas id="gl1"></canvas>
      </div>

      <!-- Viewer Info Bar -->
      <div class="viewer-info">
        <span id="intensity">Upload an image to begin</span>
      </div>

      <!-- Console -->
      <div class="console-container" id="console">
        <div class="console-header">
          <span class="console-title">Console</span>
          <button class="console-clear" id="clearConsole">Clear</button>
        </div>
        <div class="console-output" id="consoleOutput">
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="app-footer">
      <span>QSMbly | Browser-based Quantitative Susceptibility Mapping</span>
      <span>Powered by Rust, WebAssembly &amp; NiiVue</span>
    </footer>
  </div>

  <!-- Modals (outside app-container for proper z-index stacking) -->
  <!-- Pipeline Settings Modal -->
  <div class="modal-overlay" id="pipelineSettingsModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Pipeline Settings</h3>
        <button class="modal-close" id="closePipelineSettings">&times;</button>
      </div>
      <div class="modal-body">
        <!-- QSM Reconstruction Method Section -->
        <div class="settings-section">
          <h4>QSM Reconstruction</h4>
          <div class="param-group">
            <label class="param-label" for="combinedMethod">Method</label>
            <select id="combinedMethod">
              <option value="none" selected>Standard Pipeline (BG Removal + Inversion)</option>
              <option value="tgv">TGV Single-Step</option>
              <option value="qsmart">QSMART (Two-stage Vessel Artifact Reduction)</option>
            </select>
          </div>

          <!-- TGV Settings -->
          <div id="tgvSettings" class="method-settings" style="display: none;">
            <div class="param-hint" style="margin-bottom: var(--space-sm); color: var(--color-text-muted);">
              TGV performs background removal and dipole inversion in one step.
              For multi-echo data, B0 estimation is still performed first.
            </div>
            <div class="param-group">
              <label class="param-label" for="tgvRegularization">Regularization Level</label>
              <select id="tgvRegularization">
                <option value="1">1 - Low (sharper, more noise)</option>
                <option value="2" selected>2 - Default</option>
                <option value="3">3 - High (smoother)</option>
                <option value="4">4 - Very High (very smooth)</option>
              </select>
            </div>
            <div class="param-group">
              <label class="param-label" for="tgvIterations">Iterations</label>
              <input type="number" id="tgvIterations" value="1000" min="100" max="5000" step="100">
            </div>
            <div class="param-group">
              <label class="param-label" for="tgvErosions">Mask Erosions</label>
              <input type="number" id="tgvErosions" value="3" min="0" max="10" step="1">
            </div>
          </div>

          <!-- QSMART Settings -->
          <div id="qsmartSettings" class="method-settings" style="display: none;">
            <div class="param-hint" style="margin-bottom: var(--space-sm); color: var(--color-text-muted);">
              QSMART uses two-stage reconstruction with Spatially Dependent Filtering (SDF)
              to reduce streaking artifacts from vessels and veins. Stage 1 processes the
              entire ROI, Stage 2 processes tissue only (excluding vessels detected via Frangi).
            </div>

            <h5 style="margin: var(--space-sm) 0 var(--space-xs); font-size: 0.8rem; color: var(--color-text-muted);">Stage 1: Whole ROI</h5>
            <div class="param-group">
              <label class="param-label" for="qsmartSdfSigma1Stage1">SDF Sigma 1 (voxels)</label>
              <input type="number" id="qsmartSdfSigma1Stage1" value="10" min="1" max="30" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="qsmartSdfSigma2Stage1">SDF Sigma 2 (voxels)</label>
              <input type="number" id="qsmartSdfSigma2Stage1" value="0" min="0" max="30" step="1">
            </div>

            <h5 style="margin: var(--space-sm) 0 var(--space-xs); font-size: 0.8rem; color: var(--color-text-muted);">Stage 2: Tissue Only</h5>
            <div class="param-group">
              <label class="param-label" for="qsmartSdfSigma1Stage2">SDF Sigma 1 (voxels)</label>
              <input type="number" id="qsmartSdfSigma1Stage2" value="8" min="1" max="30" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="qsmartSdfSigma2Stage2">SDF Sigma 2 (voxels)</label>
              <input type="number" id="qsmartSdfSigma2Stage2" value="2" min="0" max="30" step="1">
            </div>

            <h5 style="margin: var(--space-sm) 0 var(--space-xs); font-size: 0.8rem; color: var(--color-text-muted);">SDF Parameters</h5>
            <div class="param-group">
              <label class="param-label" for="qsmartSdfSpatialRadius">Spatial Radius (voxels)</label>
              <input type="number" id="qsmartSdfSpatialRadius" value="8" min="1" max="20" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="qsmartSdfLowerLim">Lower Limit (proximity)</label>
              <input type="number" id="qsmartSdfLowerLim" value="0.6" min="0.1" max="1.0" step="0.1">
            </div>
            <div class="param-group">
              <label class="param-label" for="qsmartSdfCurvConstant">Curvature Constant</label>
              <input type="number" id="qsmartSdfCurvConstant" value="500" min="100" max="2000" step="50">
            </div>

            <h5 style="margin: var(--space-sm) 0 var(--space-xs); font-size: 0.8rem; color: var(--color-text-muted);">Vasculature Detection (Frangi)</h5>
            <p style="font-size: 0.7rem; color: var(--color-text-muted); margin: 0 0 var(--space-xs);">Parameters in mm - auto-scaled to voxels</p>
            <div class="param-group">
              <label class="param-label" for="qsmartVascSphereRadius">Bottom-hat Radius (mm)</label>
              <input type="number" id="qsmartVascSphereRadius" value="8" min="2" max="20" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="qsmartFrangiScaleMin">Min Vessel Radius (mm)</label>
              <input type="number" id="qsmartFrangiScaleMin" value="1.0" min="0.5" max="5.0" step="0.5">
            </div>
            <div class="param-group">
              <label class="param-label" for="qsmartFrangiScaleMax">Max Vessel Radius (mm)</label>
              <input type="number" id="qsmartFrangiScaleMax" value="10.0" min="1.0" max="20.0" step="1.0">
            </div>
            <div class="param-group">
              <label class="param-label" for="qsmartFrangiScaleRatio">Scale Step (mm)</label>
              <input type="number" id="qsmartFrangiScaleRatio" value="2.0" min="0.5" max="5.0" step="0.5">
            </div>
            <div class="param-group">
              <label class="param-label" for="qsmartFrangiC">Frangi C (noise threshold)</label>
              <input type="number" id="qsmartFrangiC" value="500" min="100" max="2000" step="50">
            </div>

            <h5 style="margin: var(--space-sm) 0 var(--space-xs); font-size: 0.8rem; color: var(--color-text-muted);">iLSQR Inversion</h5>
            <div class="param-group">
              <label class="param-label" for="qsmartIlsqrTol">Tolerance</label>
              <input type="number" id="qsmartIlsqrTol" value="0.01" min="0.001" max="0.1" step="0.001">
            </div>
            <div class="param-group">
              <label class="param-label" for="qsmartIlsqrMaxIter">Max Iterations</label>
              <input type="number" id="qsmartIlsqrMaxIter" value="50" min="10" max="200" step="10">
            </div>
          </div>
        </div>

        <!-- Multi-echo B0 Estimation Section -->
        <div class="settings-section" id="multiEchoSection">
          <h4>Multi-echo B0 Estimation</h4>
          <div class="param-hint" style="margin-bottom: var(--space-sm); color: var(--color-text-muted);">
            Combines multiple echoes to estimate B0. All methods require phase unwrapping
            (OLS methods use settings below; MCPC-3D-S uses ROMEO internally).
          </div>

          <div class="param-group">
            <label class="param-label" for="multiEchoMethod">Method</label>
            <select id="multiEchoMethod">
              <option value="ols">OLS (assumes zero phase offset)</option>
              <option value="ols_offset">OLS with Offset</option>
              <option value="mcpc3ds" selected>MCPC-3D-S (Recommended)</option>
            </select>
          </div>

          <!-- Nested Phase Unwrapping for OLS methods -->
          <div id="multiEchoUnwrapSettings" class="method-settings" style="margin-left: var(--space-md); padding-left: var(--space-md); border-left: 2px solid var(--color-border);">
            <div class="param-group">
              <label class="param-label" for="unwrapMethod">Phase Unwrapping</label>
              <select id="unwrapMethod">
                <option value="romeo" selected>ROMEO (Quality-guided)</option>
                <option value="laplacian">Laplacian (Fast)</option>
              </select>
            </div>

            <!-- ROMEO Settings -->
            <div id="romeoSettings" class="method-settings">
              <div class="param-group">
                <label class="param-label" for="romeoWeighting">ROMEO Weighting</label>
                <select id="romeoWeighting">
                  <option value="phase_snr" selected>Phase SNR (Recommended)</option>
                  <option value="magnitude">Magnitude</option>
                  <option value="uniform">Uniform</option>
                </select>
              </div>
            </div>

            <!-- Laplacian Settings -->
            <div id="laplacianSettings" class="method-settings" style="display: none;">
              <div class="param-hint" style="color: var(--color-text-muted);">
                Laplacian is faster but may have residual wraps in noisy regions
              </div>
            </div>
          </div>

          <!-- MCPC-3D-S Settings -->
          <div id="mcpc3dsSettings" class="method-settings" style="display: none;">
            <div class="param-hint" style="margin-bottom: var(--space-sm); color: var(--color-text-muted);">
              Estimates phase offset using Hermitian Inner Product with Gaussian smoothing.
            </div>
            <div class="param-group">
              <label class="param-label" for="mcpc3dsSigmaX">Smoothing Sigma X (voxels)</label>
              <input type="number" id="mcpc3dsSigmaX" value="10" min="1" max="30" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="mcpc3dsSigmaY">Smoothing Sigma Y (voxels)</label>
              <input type="number" id="mcpc3dsSigmaY" value="10" min="1" max="30" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="mcpc3dsSigmaZ">Smoothing Sigma Z (voxels)</label>
              <input type="number" id="mcpc3dsSigmaZ" value="5" min="1" max="30" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="mcpc3dsWeightType">B0 Weighting</label>
              <select id="mcpc3dsWeightType">
                <option value="phase_snr" selected>Phase SNR (mag × TE)</option>
                <option value="phase_var">Phase Variance (mag² × TE²)</option>
                <option value="average">Uniform</option>
                <option value="tes">TE only</option>
                <option value="mag">Magnitude only</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Phase Unwrapping for Single-echo (Standard pipeline only) -->
        <div class="settings-section" id="singleEchoUnwrapSection" style="display: none;">
          <h4>Phase Unwrapping</h4>
          <div class="param-hint" style="margin-bottom: var(--space-sm); color: var(--color-text-muted);">
            Single-echo phase unwrapping settings
          </div>
          <div class="param-group">
            <label class="param-label" for="singleEchoUnwrapMethod">Method</label>
            <select id="singleEchoUnwrapMethod">
              <option value="romeo" selected>ROMEO (Quality-guided)</option>
              <option value="laplacian">Laplacian (Fast)</option>
            </select>
          </div>
          <div id="singleEchoRomeoSettings" class="method-settings">
            <div class="param-group">
              <label class="param-label" for="singleEchoRomeoWeighting">ROMEO Weighting</label>
              <select id="singleEchoRomeoWeighting">
                <option value="phase_snr" selected>Phase SNR (Recommended)</option>
                <option value="magnitude">Magnitude</option>
                <option value="uniform">Uniform</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Background Removal -->
        <div class="settings-section" id="bgRemovalSection">
          <h4>Background Removal</h4>
          <div class="param-group">
            <label class="param-label" for="bgRemovalMethod">Method</label>
            <select id="bgRemovalMethod">
              <option value="vsharp" selected>V-SHARP (Variable radii)</option>
              <option value="sharp">SHARP (Single radius + deconvolution)</option>
              <option value="smv">SMV (Single radius)</option>
              <option value="ismv">iSMV (Iterative)</option>
              <option value="pdf">PDF (Projection onto Dipole Fields)</option>
              <option value="lbv">LBV (Laplacian Boundary Value)</option>
            </select>
          </div>

          <!-- V-SHARP Settings -->
          <div id="vsharpSettings" class="method-settings">
            <div class="param-group">
              <label class="param-label" for="vsharpMaxRadius">Max Radius (mm)</label>
              <input type="number" id="vsharpMaxRadius" value="18" min="4" max="30" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="vsharpMinRadius">Min Radius (mm)</label>
              <input type="number" id="vsharpMinRadius" value="2" min="1" max="10" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="vsharpThreshold">Threshold</label>
              <input type="number" id="vsharpThreshold" value="0.05" min="0.01" max="0.2" step="0.01">
            </div>
          </div>

          <!-- SHARP Settings -->
          <div id="sharpSettings" class="method-settings" style="display: none;">
            <div class="param-hint" style="margin-bottom: var(--space-sm); color: var(--color-text-muted);">
              High-pass filter with deconvolution - more aggressive than simple SMV
            </div>
            <div class="param-group">
              <label class="param-label" for="sharpRadius">Radius (mm)</label>
              <input type="number" id="sharpRadius" value="6" min="1" max="20" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="sharpThreshold">Threshold</label>
              <input type="number" id="sharpThreshold" value="0.05" min="0.01" max="0.2" step="0.01">
            </div>
          </div>

          <!-- SMV Settings -->
          <div id="smvSettings" class="method-settings">
            <div class="param-group">
              <label class="param-label" for="smvRadius">Radius (mm)</label>
              <input type="number" id="smvRadius" value="5" min="1" max="20" step="1">
            </div>
          </div>

          <!-- iSMV Settings -->
          <div id="ismvSettings" class="method-settings" style="display: none;">
            <div class="param-hint" style="margin-bottom: var(--space-sm); color: var(--color-text-muted);">
              Iterative SMV - more accurate than single-pass SMV
            </div>
            <div class="param-group">
              <label class="param-label" for="ismvRadius">Radius (mm)</label>
              <input type="number" id="ismvRadius" value="5" min="1" max="20" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="ismvTol">Tolerance</label>
              <input type="number" id="ismvTol" value="0.001" min="0.0001" max="0.01" step="0.0001">
            </div>
            <div class="param-group">
              <label class="param-label" for="ismvMaxit">Max Iterations</label>
              <input type="number" id="ismvMaxit" value="500" min="50" max="1000" step="50">
            </div>
          </div>

          <!-- PDF Settings -->
          <div id="pdfSettings" class="method-settings" style="display: none;">
            <div class="param-hint" style="margin-bottom: var(--space-sm); color: var(--color-text-muted);">
              Projects field onto space orthogonal to background dipole fields
            </div>
            <div class="param-group">
              <label class="param-label" for="pdfTol">Tolerance</label>
              <input type="number" id="pdfTol" value="0.00001" min="0.000001" max="0.001" step="0.000001">
            </div>
            <div class="param-group">
              <label class="param-label" for="pdfMaxit">Max Iterations</label>
              <input type="number" id="pdfMaxit" value="100" min="10" max="500" step="10">
            </div>
          </div>

          <!-- LBV Settings -->
          <div id="lbvSettings" class="method-settings" style="display: none;">
            <div class="param-hint" style="margin-bottom: var(--space-sm); color: var(--color-text-muted);">
              Laplacian Boundary Value - solves Poisson equation with Dirichlet BCs
            </div>
            <div class="param-group">
              <label class="param-label" for="lbvTol">Tolerance</label>
              <input type="number" id="lbvTol" value="0.001" min="0.0001" max="0.01" step="0.0001">
            </div>
            <div class="param-group">
              <label class="param-label" for="lbvMaxit">Max Iterations</label>
              <input type="number" id="lbvMaxit" value="500" min="50" max="2000" step="50">
            </div>
          </div>
        </div>

        <!-- Dipole Inversion -->
        <div class="settings-section" id="dipoleInversionSection">
          <h4>Dipole Inversion</h4>
          <div class="param-group">
            <label class="param-label" for="dipoleMethod">Method</label>
            <select id="dipoleMethod">
              <option value="tkd">TKD (Instant - basic)</option>
              <option value="tsvd">TSVD (Instant - smoother)</option>
              <option value="tikhonov">Tikhonov (Instant - smooth)</option>
              <option value="tv" selected>TV-ADMM (Fast - edge-preserving)</option>
              <option value="rts">RTS (Fast - iterative)</option>
              <option value="nltv">NLTV (Slow - non-local TV)</option>
              <option value="medi">MEDI (Morphology-weighted)</option>
              <option value="ilsqr">iLSQR (Streaking artifact removal)</option>
            </select>
          </div>

          <!-- TKD Settings -->
          <div id="tkdSettings" class="method-settings" style="display: none;">
            <div class="param-hint" style="margin-bottom: var(--space-sm); color: var(--color-text-muted);">
              Truncated K-space Division - instant but may have streaking artifacts
            </div>
            <div class="param-group">
              <label class="param-label" for="tkdThreshold">Threshold</label>
              <input type="number" id="tkdThreshold" value="0.15" min="0.05" max="0.3" step="0.01">
            </div>
          </div>

          <!-- TSVD Settings -->
          <div id="tsvdSettings" class="method-settings" style="display: none;">
            <div class="param-hint" style="margin-bottom: var(--space-sm); color: var(--color-text-muted);">
              Truncated SVD - zeros small values (smoother than TKD)
            </div>
            <div class="param-group">
              <label class="param-label" for="tsvdThreshold">Threshold</label>
              <input type="number" id="tsvdThreshold" value="0.15" min="0.05" max="0.3" step="0.01">
            </div>
          </div>

          <!-- Tikhonov Settings -->
          <div id="tikhonovSettings" class="method-settings" style="display: none;">
            <div class="param-hint" style="margin-bottom: var(--space-sm); color: var(--color-text-muted);">
              L2-regularized solution - instant with smooth results
            </div>
            <div class="param-group">
              <label class="param-label" for="tikhLambda">Lambda (regularization)</label>
              <input type="number" id="tikhLambda" value="0.01" min="0.001" max="1.0" step="0.001">
            </div>
            <div class="param-group">
              <label class="param-label" for="tikhReg">Regularization Type</label>
              <select id="tikhReg">
                <option value="identity" selected>Identity (minimal smoothing)</option>
                <option value="gradient">Gradient (moderate smoothing)</option>
                <option value="laplacian">Laplacian (strong smoothing)</option>
              </select>
            </div>
          </div>

          <!-- TV-ADMM Settings -->
          <div id="tvSettings" class="method-settings">
            <div class="param-hint" style="margin-bottom: var(--space-sm); color: var(--color-text-muted);">
              Total Variation with ADMM - fast iterative, edge-preserving
            </div>
            <div class="param-group">
              <label class="param-label" for="tvLambda">Lambda (TV regularization)</label>
              <input type="number" id="tvLambda" value="0.001" min="0.0001" max="0.1" step="0.0001">
            </div>
            <div class="param-group">
              <label class="param-label" for="tvMaxIter">Max Iterations</label>
              <input type="number" id="tvMaxIter" value="250" min="10" max="500" step="10">
            </div>
            <div class="param-group">
              <label class="param-label" for="tvTol">Tolerance</label>
              <input type="number" id="tvTol" value="0.001" min="0.0001" max="0.01" step="0.0001">
            </div>
          </div>

          <!-- RTS Settings -->
          <div id="rtsSettings" class="method-settings" style="display: none;">
            <div class="param-group">
              <label class="param-label" for="rtsDelta">Delta (threshold)</label>
              <input type="number" id="rtsDelta" value="0.15" min="0.05" max="0.3" step="0.01">
            </div>
            <div class="param-group">
              <label class="param-label" for="rtsMu">Mu (data fidelity)</label>
              <input type="number" id="rtsMu" value="100000" min="1000" max="1000000" step="1000">
            </div>
            <div class="param-group">
              <label class="param-label" for="rtsRho">Rho (ADMM penalty)</label>
              <input type="number" id="rtsRho" value="10" min="1" max="100" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="rtsMaxIter">Max Iterations</label>
              <input type="number" id="rtsMaxIter" value="20" min="5" max="100" step="5">
            </div>
          </div>

          <!-- NLTV Settings -->
          <div id="nltvSettings" class="method-settings" style="display: none;">
            <div class="param-hint" style="margin-bottom: var(--space-sm); color: var(--color-text-muted);">
              Non-linear TV with ADMM - best quality but slow
            </div>
            <div class="param-group">
              <label class="param-label" for="nltvLambda">Lambda (TV regularization)</label>
              <input type="number" id="nltvLambda" value="0.001" min="0.0001" max="0.1" step="0.0001">
            </div>
            <div class="param-group">
              <label class="param-label" for="nltvMu">Mu (data fidelity)</label>
              <input type="number" id="nltvMu" value="1" min="0.1" max="10" step="0.1">
            </div>
            <div class="param-group">
              <label class="param-label" for="nltvMaxIter">Max Iterations</label>
              <input type="number" id="nltvMaxIter" value="250" min="50" max="1000" step="50">
            </div>
            <div class="param-group">
              <label class="param-label" for="nltvTol">Tolerance</label>
              <input type="number" id="nltvTol" value="0.001" min="0.0001" max="0.01" step="0.0001">
            </div>
            <div class="param-group">
              <label class="param-label" for="nltvNewtonMaxIter">Newton Max Iterations</label>
              <input type="number" id="nltvNewtonMaxIter" value="10" min="1" max="50" step="1">
            </div>
          </div>

          <!-- MEDI Settings -->
          <div id="mediSettings" class="method-settings" style="display: none;">
            <div class="param-hint" style="margin-bottom: var(--space-sm); color: var(--color-text-muted);">
              Morphology Enabled Dipole Inversion - uses magnitude edges for regularization
            </div>
            <div class="param-group">
              <label class="param-label" for="mediLambda">Lambda (regularization)</label>
              <input type="number" id="mediLambda" value="7.5e-5" min="1e-6" max="0.01" step="1e-5">
            </div>
            <div class="param-group">
              <label class="param-label" for="mediPercentage">Edge Percentage</label>
              <input type="number" id="mediPercentage" value="0.3" min="0.05" max="0.95" step="0.05">
            </div>
            <div class="param-group">
              <label class="param-label" for="mediMaxIter">Max Iterations</label>
              <input type="number" id="mediMaxIter" value="30" min="1" max="100" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="mediCgMaxIter">CG Max Iterations</label>
              <input type="number" id="mediCgMaxIter" value="10" min="1" max="100" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="mediSmv">
                <input type="checkbox" id="mediSmv"> Enable SMV preprocessing
              </label>
            </div>
            <div class="param-group" id="mediSmvRadiusGroup" style="display: none;">
              <label class="param-label" for="mediSmvRadius">SMV Radius (mm)</label>
              <input type="number" id="mediSmvRadius" value="5" min="1" max="20" step="1">
            </div>
            <div class="param-group">
              <label class="param-label" for="mediMerit">
                <input type="checkbox" id="mediMerit"> Enable Merit adjustment
              </label>
            </div>
          </div>

          <!-- iLSQR Settings -->
          <div id="ilsqrSettings" class="method-settings" style="display: none;">
            <div class="param-hint" style="margin-bottom: var(--space-sm); color: var(--color-text-muted);">
              Iterative LSQR with streaking artifact removal (Li et al., 2015)
            </div>
            <div class="param-group">
              <label class="param-label" for="ilsqrTol">Tolerance</label>
              <input type="number" id="ilsqrTol" value="0.01" min="0.001" max="0.1" step="0.001">
            </div>
            <div class="param-group">
              <label class="param-label" for="ilsqrMaxIter">Max Iterations</label>
              <input type="number" id="ilsqrMaxIter" value="50" min="10" max="200" step="10">
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="resetPipelineSettings">Reset Defaults</button>
        <button class="btn btn-primary" id="runPipelineWithSettings">Run Pipeline</button>
      </div>
    </div>
  </div>

  <!-- BET Settings Modal -->
  <div class="modal-overlay" id="betSettingsModal">
    <div class="modal">
      <div class="modal-header">
        <h3>BET Settings</h3>
        <button class="modal-close" id="closeBetSettings">&times;</button>
      </div>
      <div class="modal-body">
        <div class="settings-section">
          <h4>Brain Extraction Parameters</h4>
          <div class="param-group">
            <label class="param-label" for="betFractionalIntensity">Fractional Intensity</label>
            <div class="param-hint">Smaller values give larger brain estimate (0.0-1.0)</div>
            <input type="range" id="betFractionalIntensity" min="0.1" max="0.9" value="0.5" step="0.05" class="threshold-slider">
            <div class="param-value-display"><span id="betFractionalIntensityValue">0.5</span></div>
          </div>
          <div class="param-group">
            <label class="param-label" for="betIterations">Iterations</label>
            <div class="param-hint">More iterations = smoother result but slower (100-2000)</div>
            <input type="number" id="betIterations" value="1000" min="100" max="2000" step="100">
          </div>
          <div class="param-group">
            <label class="param-label" for="betSubdivisions">Mesh Subdivisions</label>
            <div class="param-hint">3 = 642 vertices, 4 = 2562 vertices, 5 = 10242 vertices</div>
            <input type="number" id="betSubdivisions" value="4" min="2" max="5" step="1">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="resetBetSettings">Reset Defaults</button>
        <button class="btn btn-primary" id="runBetWithSettings">Run BET</button>
      </div>
    </div>
  </div>

  <!-- Application Script -->
  <script src="js/qsm-app-romeo.js"></script>

  <!-- Additional UI Interactions -->
  <script>
    // View tab switching
    document.querySelectorAll('.view-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        if (!window.app || !window.app.nv) return;

        document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        const view = tab.dataset.view;
        const nv = window.app.nv;

        switch(view) {
          case 'multiplanar':
            nv.setSliceType(nv.sliceTypeMultiplanar);
            break;
          case 'axial':
            nv.setSliceType(nv.sliceTypeAxial);
            break;
          case 'coronal':
            nv.setSliceType(nv.sliceTypeCoronal);
            break;
          case 'sagittal':
            nv.setSliceType(nv.sliceTypeSagittal);
            break;
          case 'render':
            nv.setSliceType(nv.sliceTypeRender);
            break;
        }
      });
    });

    // Colormap selection
    document.getElementById('colormapSelect').addEventListener('change', (e) => {
      if (!window.app || !window.app.nv) return;
      const nv = window.app.nv;
      if (!nv.volumes || nv.volumes.length === 0 || !nv.volumes[0]) return;
      try {
        nv.volumes[0].colormap = e.target.value;
        nv.updateGLVolume();
      } catch (err) {
        console.warn('Could not set colormap:', err);
      }
    });

    // Window controls (min/max intensity) with dual range slider
    const windowState = { dataMin: 0, dataMax: 100, currentMin: 0, currentMax: 100 };

    function updateRangeHighlight() {
      const rangeMin = document.getElementById('rangeMin');
      const rangeMax = document.getElementById('rangeMax');
      const selected = document.getElementById('rangeSelected');
      const minPercent = ((rangeMin.value - rangeMin.min) / (rangeMin.max - rangeMin.min)) * 100;
      const maxPercent = ((rangeMax.value - rangeMax.min) / (rangeMax.max - rangeMax.min)) * 100;
      selected.style.left = minPercent + '%';
      selected.style.width = (maxPercent - minPercent) + '%';
    }

    function sliderToValue(sliderVal) {
      return windowState.dataMin + (sliderVal / 100) * (windowState.dataMax - windowState.dataMin);
    }

    function valueToSlider(val) {
      if (windowState.dataMax === windowState.dataMin) return 50;
      return ((val - windowState.dataMin) / (windowState.dataMax - windowState.dataMin)) * 100;
    }

    function applyWindow(minVal, maxVal) {
      if (!window.app || !window.app.nv || !window.app.nv.volumes.length) return;
      const vol = window.app.nv.volumes[0];
      vol.cal_min = minVal;
      vol.cal_max = maxVal;
      window.app.nv.updateGLVolume();
    }

    function syncFromSliders() {
      const minSlider = document.getElementById('rangeMin');
      const maxSlider = document.getElementById('rangeMax');
      // Prevent crossover
      if (parseInt(minSlider.value) > parseInt(maxSlider.value) - 1) {
        minSlider.value = parseInt(maxSlider.value) - 1;
      }
      if (parseInt(maxSlider.value) < parseInt(minSlider.value) + 1) {
        maxSlider.value = parseInt(minSlider.value) + 1;
      }
      const minVal = sliderToValue(parseFloat(minSlider.value));
      const maxVal = sliderToValue(parseFloat(maxSlider.value));
      document.getElementById('windowMin').value = minVal.toFixed(2);
      document.getElementById('windowMax').value = maxVal.toFixed(2);
      updateRangeHighlight();
      applyWindow(minVal, maxVal);
    }

    function syncFromInputs() {
      const minInput = document.getElementById('windowMin');
      const maxInput = document.getElementById('windowMax');
      let minVal = parseFloat(minInput.value) || windowState.dataMin;
      let maxVal = parseFloat(maxInput.value) || windowState.dataMax;
      // Clamp to data range
      minVal = Math.max(windowState.dataMin, Math.min(windowState.dataMax, minVal));
      maxVal = Math.max(windowState.dataMin, Math.min(windowState.dataMax, maxVal));
      if (minVal > maxVal) { const t = minVal; minVal = maxVal; maxVal = t; }
      document.getElementById('rangeMin').value = valueToSlider(minVal);
      document.getElementById('rangeMax').value = valueToSlider(maxVal);
      updateRangeHighlight();
      applyWindow(minVal, maxVal);
    }

    document.getElementById('rangeMin').addEventListener('input', syncFromSliders);
    document.getElementById('rangeMax').addEventListener('input', syncFromSliders);
    document.getElementById('windowMin').addEventListener('change', syncFromInputs);
    document.getElementById('windowMax').addEventListener('change', syncFromInputs);

    document.getElementById('resetWindow').addEventListener('click', () => {
      if (!window.app || !window.app.nv || !window.app.nv.volumes.length) return;
      const vol = window.app.nv.volumes[0];
      // Use NiiVue's built-in robust (percentile-based) min/max
      const min = vol.robust_min ?? vol.global_min;
      const max = vol.robust_max ?? vol.global_max;
      windowState.currentMin = min;
      windowState.currentMax = max;
      document.getElementById('windowMin').value = min.toFixed(2);
      document.getElementById('windowMax').value = max.toFixed(2);
      document.getElementById('rangeMin').value = valueToSlider(min);
      document.getElementById('rangeMax').value = valueToSlider(max);
      updateRangeHighlight();
      applyWindow(min, max);
    });

    // Update window controls when a new volume is loaded
    function initWindowControls() {
      if (!window.app || !window.app.nv || !window.app.nv.volumes.length) return;
      const vol = window.app.nv.volumes[0];
      windowState.dataMin = vol.global_min;
      windowState.dataMax = vol.global_max;
      windowState.currentMin = vol.cal_min;
      windowState.currentMax = vol.cal_max;
      document.getElementById('windowMin').value = vol.cal_min.toFixed(2);
      document.getElementById('windowMax').value = vol.cal_max.toFixed(2);
      document.getElementById('rangeMin').value = valueToSlider(vol.cal_min);
      document.getElementById('rangeMax').value = valueToSlider(vol.cal_max);
      updateRangeHighlight();
    }

    // Watch for volume changes
    const volumeObserver = setInterval(() => {
      if (window.app && window.app.nv && window.app.nv.volumes.length > 0) {
        const vol = window.app.nv.volumes[0];
        if (vol.global_min !== windowState.dataMin || vol.global_max !== windowState.dataMax) {
          initWindowControls();
        }
      }
    }, 500);

    // Interpolation checkbox (disabled by default)
    document.getElementById('interpolation').addEventListener('change', (e) => {
      if (!window.app || !window.app.nv) return;
      window.app.nv.setInterpolation(!e.target.checked); // checked = smooth, unchecked = nearest
      window.app.nv.drawScene();
    });

    // Initialize interpolation off (nearest neighbor) when app loads
    const initInterp = setInterval(() => {
      if (window.app && window.app.nv) {
        window.app.nv.setInterpolation(true); // true = nearest neighbor (no interpolation)
        clearInterval(initInterp);
      }
    }, 500);

    // Clear console
    document.getElementById('clearConsole').addEventListener('click', () => {
      const consoleOutput = document.getElementById('consoleOutput');
      if (consoleOutput) consoleOutput.innerHTML = '';
    });

    // Drag and drop enhancement
    ['magnitudeDrop', 'phaseDrop', 'jsonDrop'].forEach(id => {
      const dropZone = document.getElementById(id);
      if (!dropZone) return;

      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const input = dropZone.querySelector('input[type="file"]');
        if (input && e.dataTransfer.files.length) {
          input.files = e.dataTransfer.files;
          input.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
    });

  </script>

  <style>
    /* Additional styles for stage buttons grid */
    .stage-buttons-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-xs);
    }

    .stage-item {
      display: flex;
      gap: 2px;
    }

    .stage-item .stage-tab {
      flex: 1;
      font-size: 0.7rem;
      padding: var(--space-xs);
    }

    .stage-item .btn:last-child {
      padding: var(--space-xs);
    }

    .stage-item .btn:last-child svg {
      width: 12px;
      height: 12px;
    }

    /* Mask preview buttons */
    .mask-preview-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-xs);
      margin-top: var(--space-sm);
    }

    .mask-preview-buttons .btn {
      font-size: 0.7rem;
      padding: var(--space-xs) var(--space-sm);
    }

    /* Mask operation buttons */
    .mask-op-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-xs);
    }

    .mask-op-buttons .btn {
      font-size: 0.7rem;
      padding: var(--space-xs) var(--space-sm);
    }

    /* Drawing controls */
    .drawing-controls {
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
    }

    .brush-mode-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: var(--space-xs);
    }

    .brush-mode-buttons .btn {
      font-size: 0.65rem;
      padding: var(--space-xs);
    }

    .brush-mode-buttons .btn.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    .brush-size-control {
      padding: var(--space-xs) 0;
    }

    .drawing-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-xs);
    }

    .drawing-actions .btn {
      font-size: 0.7rem;
    }

    /* Threshold slider */
    .threshold-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-xs);
    }

    .threshold-slider {
      width: 100%;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      background: var(--color-border);
      border-radius: 3px;
      outline: none;
      cursor: pointer;
    }

    .threshold-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      background: var(--color-primary);
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .threshold-slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    .threshold-slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: var(--color-primary);
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }

    .threshold-slider:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .threshold-slider:disabled::-webkit-slider-thumb {
      background: var(--color-text-muted);
      cursor: not-allowed;
    }

    .threshold-slider:disabled::-moz-range-thumb {
      background: var(--color-text-muted);
      cursor: not-allowed;
    }

    /* Compact preview buttons */
    .preview-buttons {
      display: flex;
      gap: var(--space-xs);
      margin-top: var(--space-sm);
    }

    .preview-buttons .btn {
      flex: 1;
      font-size: 0.7rem;
      padding: var(--space-xs) var(--space-sm);
    }

    .preview-buttons .btn svg {
      width: 12px;
      height: 12px;
    }

    /* Inline param with unit */
    .param-inline {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .param-inline input {
      flex: 1;
    }

    .param-inline .unit {
      font-size: 0.7rem;
      color: var(--color-text-muted);
      white-space: nowrap;
    }

    /* Modal styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(2px);
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-border);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      max-width: 500px;
      width: 90%;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-md) var(--space-lg);
      border-bottom: 1px solid var(--color-border);
    }

    .modal-header h3 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--color-text);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--color-text-muted);
      padding: 0;
      line-height: 1;
      transition: color 0.15s;
    }

    .modal-close:hover {
      color: var(--color-text);
    }

    .modal-body {
      padding: var(--space-lg);
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: var(--space-sm);
      padding: var(--space-md) var(--space-lg);
      border-top: 1px solid var(--color-border);
      background: var(--color-surface-elevated);
    }

    .settings-section {
      margin-bottom: var(--space-lg);
    }

    .settings-section:last-child {
      margin-bottom: 0;
    }

    .settings-section h4 {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--color-primary);
      margin: 0 0 var(--space-sm) 0;
      padding-bottom: var(--space-xs);
      border-bottom: 1px solid var(--color-border);
    }

    .param-hint {
      font-size: 0.7rem;
      color: var(--color-text-muted);
      margin-bottom: var(--space-xs);
    }

    .param-value-display {
      text-align: center;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--color-primary);
      margin-top: var(--space-xs);
    }

    /* Method settings container */
    .method-settings {
      margin-top: var(--space-sm);
      padding: var(--space-sm);
      background: var(--color-surface-elevated);
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border);
    }

    .method-settings .param-group:last-child {
      margin-bottom: 0;
    }

    /* Checkbox styling */
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      cursor: pointer;
      font-size: 0.85rem;
    }

    .checkbox-label input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: var(--color-primary);
    }

    /* Window controls */
    .viewer-actions {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      flex-wrap: wrap;
    }

    .window-controls {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
    }

    .window-input {
      width: 80px;
      max-width: 80px;
      padding: 3px 3px;
      font-size: 0.7rem;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      background: var(--color-surface);
      color: var(--color-text);
      text-align: center;
      -moz-appearance: textfield;
    }

    .window-input::-webkit-outer-spin-button,
    .window-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .window-input::placeholder {
      color: var(--color-text-muted);
      font-size: 0.65rem;
    }

    .window-controls .btn-sm {
      padding: 3px 8px;
      font-size: 0.65rem;
    }

    /* Dual range slider */
    .range-slider-container {
      position: relative;
      width: 180px;
      height: 20px;
      display: flex;
      align-items: center;
    }

    .range-track {
      position: absolute;
      width: 100%;
      height: 4px;
      background: var(--color-border);
      border-radius: 2px;
      pointer-events: none;
      z-index: 1;
    }

    .range-selected {
      position: absolute;
      height: 4px;
      background: var(--color-primary);
      border-radius: 2px;
      pointer-events: none;
      z-index: 2;
    }

    .range-slider {
      position: absolute;
      width: 100%;
      height: 20px;
      -webkit-appearance: none;
      appearance: none;
      background: transparent;
      pointer-events: none;
      margin: 0;
      z-index: 3;
    }

    .range-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      background: var(--color-primary);
      border-radius: 50%;
      cursor: pointer;
      pointer-events: auto;
      border: 2px solid white;
      box-shadow: 0 1px 4px rgba(0,0,0,0.4);
      position: relative;
      z-index: 10;
    }

    .range-slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: var(--color-primary);
      border-radius: 50%;
      cursor: pointer;
      pointer-events: auto;
      border: 2px solid white;
      box-shadow: 0 1px 4px rgba(0,0,0,0.4);
    }

    .range-slider::-webkit-slider-thumb:hover {
      transform: scale(1.15);
    }

    .range-slider::-moz-range-thumb:hover {
      transform: scale(1.15);
    }

    .range-min {
      z-index: 4;
    }

    .range-max {
      z-index: 3;
    }

    .interp-checkbox {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.7rem;
      color: var(--color-text-muted);
      cursor: pointer;
      white-space: nowrap;
    }

    .interp-checkbox input[type="checkbox"] {
      width: 12px;
      height: 12px;
      cursor: pointer;
      accent-color: var(--color-primary);
    }
  </style>
</body>
</html>
